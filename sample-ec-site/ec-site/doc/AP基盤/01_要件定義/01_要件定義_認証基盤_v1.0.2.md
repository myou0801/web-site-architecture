# 要件定義書：AP基盤（認証・認可）【確定版】

- 文書名: 要件定義書（認証・認可：AP基盤）
- 対象: AP基盤チーム（認証コンテキスト）
- 版数: 1.0.2（確定）
- 更新日: 2026-01-25

> 本書は、AP基盤が提供する認証・認可機能（ログイン、パスワード変更、認証DB、業務チーム向けSharedService）について、要件を確定し、基本設計・詳細設計へトレース可能にすることを目的とする。

---

## 1. 目的・背景

### 1.1 目的
- 共通管理システムにおける認証・認可を **AP基盤として共通部品化** し、業務チームは提供I/F（SharedService）を利用して業務機能およびアカウント管理を実装できる状態にする。

### 1.2 ゴール（成果物）
- 認証系画面（ログイン／ログイン失敗／パスワード変更／変更完了）の提供
- 認証関連DBスキーマ（テーブル、インデックス、参照VIEW）の提供
- 業務チーム向けSharedService（参照・状態変更）の提供

---

## 2. スコープ

### 2.1 AP基盤チームの担当範囲（In Scope）
- 画面
  - ログイン画面
  - ログイン失敗画面（またはログイン画面での失敗表示）
  - パスワード変更画面
  - パスワード変更完了画面
- 認証関連DB
  - 認証アカウント（現在値）
  - 認証イベント履歴（ログイン、パスワード、ロック、期限、状態変更）
  - ロール／アカウントロール関連
  - Query sharedService 用 VIEW（現在状態導出、ロール行形式）
- 業務チーム向け提供（SharedService）
  - 認証状態の参照（現在アカウント、ロール、前回ログイン等）
  - 管理操作（パスワード初期化、ロック解除、有効/無効、論理削除 等）
  - 検索（アカウント一覧等：VIEW前提）

### 2.2 対象外（Out of Scope）
- 業務画面（業務メニュー、業務機能の画面・処理）
- アカウント管理UI（追加／一覧／編集／削除等）の画面実装  
  ※ただし、業務側が認証テーブルへ登録・参照するための **SharedService提供はAP基盤範囲** とする。

---

## 3. 前提・用語

### 3.1 ID命名方針（確定）
- 画面入力は「ユーザID」（DB: `user_id`, Java: `UserId`）
- 内部不変IDは「アカウントID」（DB: `auth_account_id`, Java: `AuthAccountId`）
- ログイン入力は「ログインID（login_id）」を使用する（現状は user_id を指定する仕様だが、概念としては別とする）
- ロールにより login_id（UserId）規約は変更しない（login_id の許容文字・長さ等は共通ルールとし、業務上の追加制約は業務側で担保する）

### 3.2 対象環境（確定）
- 本番DB: PostgreSQL
- 開発DB: H2（PostgreSQLモード）
- 日時型:
  - DB: `TIMESTAMP`（timezoneなし）
  - アプリ: `LocalDateTime`（JSTローカル日時として扱う）

---

## 4. 機能要件

### 4.0 要件ID採番ルール
- 機能要件: `FR-<領域>-<3桁>`（例: `FR-LOGIN-001`）
- 画面要件: `SR-<画面>-<3桁>`（Screen Requirement）
- データ要件: `DR-<領域>-<3桁>`（Data Requirement）
- 外部I/F要件: `IR-<領域>-<3桁>`（Interface Requirement）
- 非機能要件: `NFR-<領域>-<3桁>`

> 要件IDは基本設計・詳細設計（画面仕様／I/F仕様／DB設計／テスト観点）にトレースする。

### 4.1 ログイン（認証）

| 要件ID | 要件名 | 要件（概要） | 備考 |
|---|---|---|---|
| FR-LOGIN-001 | ログイン入力 | ログインID（login_id）とパスワードを入力し認証要求できること | 画面仕様は5章 |
| FR-LOGIN-002 | 認証方式 | Spring Security（DaoAuthenticationProvider）を用いたDB認証を行うこと | 実装方式は基本設計で確定 |
| FR-LOGIN-003 | 成功時遷移 | 認証成功時はメニュー画面（業務側画面）の規定遷移先へ遷移すること | 遷移先は業務側で定義（AP基盤はリダイレクト/フォワード） |
| FR-LOGIN-004 | 失敗時制御 | 認証失敗時はログイン失敗画面（SCR-LOGIN-FAIL）へ遷移し、失敗メッセージを表示すること | 決定：専用失敗画面へ遷移 |
| FR-LOGIN-005 | ロック判定 | アカウントがロック中の場合はログイン不可とすること | 4.5参照 |
| FR-LOGIN-006 | 期限切れ判定 | 期限切れの場合はログイン不可とすること | 4.6参照 |
| FR-LOGIN-007 | 履歴記録（成功） | ログイン成功時、ログイン履歴に `SUCCESS` を記録すること | 4.7参照 |
| FR-LOGIN-008 | 履歴記録（失敗） | ログイン失敗時、状態に応じた履歴（FAIL/LOCKED/DISABLED/EXPIRED等）を記録すること | 4.7参照 |
| FR-LOGIN-009 | アカウント不存在 | 入力 login_idに該当アカウントが存在しない場合、DBのログイン履歴には記録せず終了すること（ただし監査ログへ記録する） | 決定：DBは残さない／監査ログに出力 |
| FR-LOGIN-010 | 前回ログイン日時 | ログイン後、前回ログイン日時を業務側が参照できること | 共通ヘッダ表示は業務側責務 |

### 4.2 パスワード変更（ユーザー自身）

| 要件ID | 要件名 | 要件（概要） | 備考 |
|---|---|---|---|
| FR-PWD-001 | 変更画面 | ログイン中ユーザーがパスワード変更画面にて現在PW/新PW（+確認）を入力できること | URL: `/account/password/change` |
| FR-PWD-002 | 現在PW照合 | 現在PWが一致しない場合は変更不可としエラー表示すること | |
| FR-PWD-003 | パスワードポリシー | 新PWがポリシーを満たすこと（4.3参照） | |
| FR-PWD-004 | 再利用禁止 | 直近3世代と同一PWを禁止すること | 4.3参照 |
| FR-PWD-005 | 更新 | 新PWをハッシュ化し、AUTH_ACCOUNTの現在PWを更新すること | |
| FR-PWD-006 | 履歴登録 | PW変更履歴（USER_CHANGE）をAUTH_PASSWORD_HISTORYへ登録すること | |
| FR-PWD-007 | 完了遷移 | 変更完了画面へ遷移できること | URLは基本設計で確定（変更画面と同一階層を想定） |

### 4.3 パスワードポリシー（確定事項）

| 項目 | 値 |
|---|---|
| 最小桁数 | 12 |
| 文字種 | 英大文字 / 英小文字 / 数字 / 記号 のうち **3種類以上** |
| 記号の許可集合 | `#$%()+=?@*[]{}|\\` |
| UserIdとの一致禁止 | UserIdとパスワードの完全一致は禁止 |
| 有効期限 | 90日 |
| 履歴世代 | 3世代（直近3回と同一禁止） |

補足:
- ポリシー検証はクライアント表示の有無に関わらず、サーバ側で必ず実施する。

### 4.4 ロール（認可）

| 要件ID | 要件名 | 要件（概要） | 備考 |
|---|---|---|---|
| FR-ROLE-001 | 複数ロール | 1アカウントに複数ロール付与を許容すること | N:M |
| FR-ROLE-002 | 取得方式 | ロールは中間テーブルで管理し、認証時に権限へ反映できること | GrantedAuthority |
| FR-ROLE-003 | DTO返却 | Query sharedServiceの返却DTOにロール情報を含めること | 一覧はINで一括取得 |

### 4.5 アカウントロック（確定事項）

| 項目 | 値 |
|---|---|
| ロック条件 | 連続6回失敗でロック |
| ロック解除 | 管理者が明示的に解除（時間解除はしない） |
| ロック中の扱い | ロック中ログインは `AUTH_LOGIN_HISTORY.result = 'LOCKED'` を記録するが、失敗カウントには含めない |
| リセット時 | パスワード初期化（管理者リセット）でロック解除も同時実施 |

### 4.6 有効期限（期限切れ）イベント（決定事項）
- 期限切れは **ログイン時** に「最終PW変更日時 + 90日」を基準に判定する。
- 期限切れが成立した場合は、ログインを拒否し、必要に応じて `AUTH_ACCOUNT_EXPIRY_HISTORY` に `EXPIRE` を履歴登録する（冪等）。
- パスワード変更成功時は `UNEXPIRE` を履歴登録する。

### 4.7 履歴記録（監査）

| 履歴 | テーブル | 記録内容（例） |
|---|---|---|
| ログイン履歴 | `AUTH_LOGIN_HISTORY` | SUCCESS / FAILURE / LOCKED / DISABLED / DELETED / EXPIRED |
| パスワード履歴 | `AUTH_PASSWORD_HISTORY` | INITIAL_REGISTER / USER_CHANGE / ADMIN_RESET |
| ロック履歴 | `AUTH_ACCOUNT_LOCK_HISTORY` | LOCK / UNLOCK（locked=true/false）+ reason + operated_by |
| 期限履歴 | `AUTH_ACCOUNT_EXPIRY_HISTORY` | EXPIRE / UNEXPIRE + reason + operated_by |
| 状態履歴 | `AUTH_ACCOUNT_STATUS_HISTORY` | ACTIVE/DISABLED/DELETED の遷移 + reason + operated_by |

---

## 5. 画面要件

> 画面の詳細（項目、バリデーション、メッセージ、URL）は基本設計で確定する。要件定義では「画面が満たすべき要求」を規定する。

### 5.1 画面一覧

| 画面ID | 画面名 | 目的 |
|---|---|---|
| SCR-LOGIN | ログイン | 認証情報入力、認証要求 |
| SCR-LOGIN-FAIL | ログイン失敗 | 失敗時の通知（方式は要確認） |
| SCR-PWD-CHG | パスワード変更 | 現在PW照合、新PW設定 |
| SCR-PWD-CHG-COMP | パスワード変更完了 | 完了メッセージ表示 |

### 5.2 画面遷移（要件レベル）
- ログイン成功 → （パスワード変更必須なら）パスワード変更画面へ誘導、そうでなければメニュー等へ遷移
- ログイン失敗 → ログイン失敗画面（SCR-LOGIN-FAIL）へ遷移
- パスワード変更成功 → 変更完了画面へ遷移

### 5.3 パスワード変更必須判定（確定事項）
以下の場合は次回ログイン後にパスワード変更画面へ誘導する。
- パスワード履歴が存在しない（初期登録）
- 最新の変更種別が `ADMIN_RESET`（管理者リセット）
- `USER_CHANGE` だが有効期限切れ（90日超過）

---


### 5.4 画面要件（SR）

| 要件ID | 画面ID | 要件 |
|---|---|---|
| SR-LOGIN-001 | SCR-LOGIN | ログインID（login_id）/パスワードを入力できること |
| SR-LOGIN-002 | SCR-LOGIN | 入力値バリデーション（必須、型、最大桁）はサーバ側で実施すること |
| SR-LOGIN-003 | SCR-LOGIN-FAIL | 認証失敗時はログイン失敗画面へ遷移し、失敗メッセージを表示すること |
| SR-PWD-001 | SCR-PWD-CHG | 現在PW/新PW/新PW確認を入力できること |
| SR-PWD-002 | SCR-PWD-CHG | パスワードポリシー違反は画面でエラー表示すること |
| SR-PWD-003 | SCR-PWD-CHG-COMP | パスワード変更完了メッセージを表示できること |


## 6. データ要件（DB）

### 6.0 データ要件（DR）

| 要件ID | 要件 |
|---|---|
| DR-ACCOUNT-001 | 認証アカウントの現在値を `AUTH_ACCOUNT` に保持すること |
| DR-ACCOUNT-002 | ロック/期限/ログイン/PW/状態は履歴テーブル（insert-only）として保持すること |
| DR-ACCOUNT-003 | Query用途に最新状態を導出するVIEW（`AUTH_ACCOUNT_CURRENT_V` 等）を提供すること |
| DR-ROLE-001 | ロールは `AUTH_ROLE` と `AUTH_ACCOUNT_ROLE` でN:M管理すること |


### 6.1 基本方針（確定）
- `AUTH_ACCOUNT` は「現在値（投影）」を最小限保持し、ロック/期限/履歴は insert-only の履歴から導出する。
- `account_status`（ACTIVE/DISABLED/DELETED）でライフサイクル状態を管理する（enabled/deletedの分割は採用しない）。

### 6.2 テーブル一覧（確定）
- `AUTH_ACCOUNT`（更新あり）
- `AUTH_ROLE`（更新あり）
- `AUTH_ACCOUNT_ROLE`（中間）
- `AUTH_PASSWORD_HISTORY`（insert-only）
- `AUTH_LOGIN_HISTORY`（insert-only）
- `AUTH_ACCOUNT_LOCK_HISTORY`（insert-only）
- `AUTH_ACCOUNT_EXPIRY_HISTORY`（insert-only）
- `AUTH_ACCOUNT_STATUS_HISTORY`（insert-only）

### 6.3 Query sharedService 用 VIEW（確定）
- `AUTH_ACCOUNT_CURRENT_V`：locked/expired/last_login_at を最新履歴から導出
- `AUTH_ACCOUNT_ROLE_V`：auth_account_id と role_code の行形式

---

## 7. 外部インタフェース要件（業務チーム向けSharedService）

### 7.0 外部I/F要件（IR）

| 要件ID | 要件 |
|---|---|
| IR-SHARED-001 | 業務チームが認証状態（ロック/期限/前回ログイン等）を参照できるQuery I/Fを提供すること |
| IR-SHARED-002 | 業務チームがロール情報を参照できるQuery I/Fを提供すること |
| IR-SHARED-003 | 管理者操作（登録、初期化、ロック解除、有効/無効、論理削除）を実施できるCommand I/Fを提供すること |
| IR-SHARED-004 | 管理操作は操作者（operated_by）を履歴として記録すること |


### 7.1 提供I/F（候補一覧：基本設計で確定）
- Command系（状態変更）
  - `AuthAccountAdminSharedService`
    - registerAccount（新規登録）
    - resetPassword（初期化 + ロック解除）
    - unlockAccount（ロック解除）
    - disableAccount（無効化）
    - enableAccount（有効化 + 期限切れ解除）
    - deleteAccount（論理削除）
- Query系（参照：VIEW前提）
  - `AuthAccountQuerySharedService`（検索／単一取得／ロール同梱）
- Context系（ログイン中情報）
  - `AuthAccountContextSharedService`（CurrentUserProvider等）
- 認証イベント処理
  - `LoginProcessSharedService`（成功/失敗時の履歴・ロック制御）
- 期限関連
  - `AccountExpirySharedService`（expired判定、unexpireIfExpired等）
- パスワード変更
  - `PasswordChangeSharedService`

---

## 8. 非機能要件

### 8.0 非機能要件（一覧）

| 要件ID | 区分 | 要件 |
|---|---|---|
| NFR-SEC-001 | セキュリティ | 平文パスワードを保存しない（ハッシュ化して保存） |
| NFR-SEC-002 | セキュリティ | 認証失敗時メッセージはアカウント存在可否を推測できないよう制御する |
| NFR-SEC-003 | セキュリティ | 監査列を付与（created_at/created_by、必要に応じてupdated_at/updated_by） |
| NFR-SESSION-001 | セッション | 無操作タイムアウトは30分とする |
| NFR-SESSION-002 | セッション | 絶対タイムアウトは12時間とする |
| NFR-SESSION-003 | セッション | 同時ログインは最大1とし、後勝ち（新規優先で既存失効）とする |
| NFR-SESSION-004 | セッション | ログイン成功時にセッションIDを再発行し固定化を防止する |
| NFR-SESSION-005 | セッション | Remember-me は利用しない |
| NFR-OPS-001 | 運用 | アカウント不存在の試行はDBに残さず、監査ログへ出力する |
| NFR-OPS-002 | 運用 | 初期パスワード通知は管理者が実施し、手順は運用マニュアルに記載する |
| NFR-PERF-001 | 性能 | ログイン時の最新状態参照に耐える索引設計を行う（N+1回避含む） |


### 8.1 セキュリティ
- 平文パスワードは保存しない（ハッシュ化して保存）
- 失敗時メッセージはアカウント存在可否を推測できないよう制御する（要確認：FR-LOGIN-009の扱い）
- 監査列：全テーブル `created_at` / `created_by`（更新がある場合は `updated_at` / `updated_by`）

### 8.2 性能
- ログイン時は最新状態（ロック/期限/前回ログイン）参照が発生するため、インデックスを設計し性能劣化を回避する。
- Query sharedService はVIEW前提で、一覧はロールをIN一括取得しN+1を回避する。

### 8.3 運用
- 管理者操作（初期化、ロック解除、有効/無効、削除）の操作者（operated_by）を履歴に残す。
- 初期パスワードはアプリケーションプロパティにハッシュ化済み値として保持し、平文値は設定しない（詳細は 8.5 参照）。

---


### 8.4 セッション管理（決定事項）
- 無操作タイムアウト: **30分**
- 絶対タイムアウト: **12時間**
- 同時ログイン: **最大1セッション**（新規ログインを優先し、既存セッションを失効：後勝ち）
- セッション固定化対策: ログイン成功時にセッションIDを再発行する
- Remember-me: 利用しない



### 8.5 初期パスワード（決定事項）
- 初期パスワードは固定とする。ただし、**平文パスワードはアプリケーション設定に保持しない**。
- アプリケーションプロパティに **ハッシュ化（エンコード）済みパスワード** を設定し、初期登録および管理者によるパスワード初期化（リセット）時は、そのハッシュ値を現在パスワードとして設定する。
  - 例: `auth.initial-password-hash`（BCrypt等のPasswordEncoder互換のエンコード済み文字列）
- ユーザへのパスワード通知は **管理者が実施**し、通知手順・チャネル・注意事項は **運用マニュアルに記載**する（アプリケーションは平文を出力しない）。
- 新規登録時およびパスワード初期化時ともに、管理者がユーザへ通知する。


## 9. 決定事項一覧（確定）

| No | 論点 | 現状 | 決定内容 |
|---:|---|---|---|
| U-01 | login_id と user_id の関係 | 決定済 | login_id は概念上 user_id と別。現状は user_id 値を login_id 入力として運用（移行/将来拡張を考慮し分離） |
| U-02 | ログイン失敗の表示方式 | 決定済 | ログイン失敗時は専用のログイン失敗画面（SCR-LOGIN-FAIL）へ遷移する |
| U-03 | メニュー遷移先URL | 決定済 | ログイン成功時は業務側メニュー画面へ遷移（遷移先は業務側が定義） |
| U-04 | 画面URL体系 | 決定済 | パスワード変更URLは `/account/password/change` とする |
| U-05 | アカウント不存在時の履歴 | 決定済 | アカウント不存在のログイン試行はDB履歴に残さない。監査はアプリ監査ログへ出力する（運用対象） |
| U-06 | 期限切れイベントの発生契機 | 決定済 | 期限切れはログイン時に最終PW変更日時 + 90日で判定する（必要に応じて EXPIRE 履歴を登録） |
| U-07 | セッション/同時ログイン | 決定済 | 無操作30分／絶対12時間。同時ログインは最大1で後勝ち（新規優先で既存失効）。Remember-me無効。 |
| U-08 | ロールによりUserId規約が異なる件 | 決定済 | ロールにより login_id（UserId）規約は変更しない。login_id の許容ルールは共通とし、業務上の追加制約は業務側で担保する。 |
| U-09 | 初期パスワード本番値 | 決定済 | 固定初期PWはアプリケーションプロパティにハッシュ化済み値として保持。ユーザ通知は管理者が実施し、手順は運用マニュアルに記載（新規登録/初期化とも同様）。 |

---

## 10. 変更履歴

| 版数 | 日付 | 変更内容 | 作成者 |
|---|---|---|---|
| 0.1 | 2026-01-13 | ドラフト初版（既存設計メモを要件定義形式へ整理） | ChatGPT |


---

## 11. 承認

| 区分 | 氏名 | 日付 | 備考 |
|---|---|---|---|
| 作成 |  |  |  |
| レビュー |  |  |  |
| 承認 |  |  |  |

