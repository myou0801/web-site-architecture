# DB設計（DDL/インデックス/VIEW）

## テーブル方針：

- `AUTH_ACCOUNT` は **現在値（投影）** を最小限に保持（更新あり）
  - `account_status` により **有効/無効/論理削除** を表現（`enabled/deleted` は廃止）
  - パスワードの現在値は `AUTH_ACCOUNT.password_hash` に保持（ログイン処理を簡潔にするため）
  - ロック／期限切れは **履歴の最新イベント** から導出（`AUTH_ACCOUNT` に列を増やさない）
- 履歴は **insert-only**（Update を極力減らす）
  - `AUTH_LOGIN_HISTORY`（認証試行）
  - `AUTH_PASSWORD_HISTORY`（パスワード変更）
  - `AUTH_ACCOUNT_LOCK_HISTORY`（ロック／解除）
  - `AUTH_ACCOUNT_EXPIRY_HISTORY`（期限切れ／解除）
  - `AUTH_ACCOUNT_STATUS_HISTORY`（有効/無効/削除の変更）

ロールは将来拡張を前提にマスタ＋関連で表現：

- `AUTH_ROLE`
- `AUTH_ACCOUNT_ROLE`

---

- 日時型：**TIMESTAMP（timezoneなし）**
- Query sharedService 用 VIEW：
  - PostgreSQL：`DISTINCT ON`
  - H2：`row_number()` を利用

---

## H2 利用時の留意点

* 開発環境では、H2 を **PostgreSQL モード** で起動することを推奨：

  ```text
  jdbc:h2:mem:ecsite;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE;DB_CLOSE_DELAY=-1
  ```

## 1. PostgreSQL（本番用）DDL

```sql
/* =========================================================
 * PostgreSQL（本番用）
 * ========================================================= */

-- ==============
-- Tables
-- ==============

CREATE TABLE AUTH_ACCOUNT
(
    auth_account_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    user_id         VARCHAR(64)  NOT NULL,
    password_hash   VARCHAR(512) NOT NULL,

    -- ライフサイクル状態（enabled/deleted を統合）
    account_status  VARCHAR(16)  NOT NULL DEFAULT 'ACTIVE',

    created_at      TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(64)  NOT NULL,

    updated_at      TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by      VARCHAR(64)  NOT NULL,

    -- 同時更新対策（任意だが推奨）
    version         INTEGER      NOT NULL DEFAULT 0,

    CONSTRAINT ux_auth_account_user_id UNIQUE (user_id),
    CONSTRAINT ck_auth_account_status CHECK (account_status IN ('ACTIVE', 'DISABLED', 'DELETED'))
);

CREATE TABLE AUTH_ROLE
(
    auth_role_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_code    VARCHAR(64)  NOT NULL,
    role_name    VARCHAR(128) NOT NULL,
    enabled      BOOLEAN      NOT NULL DEFAULT TRUE,

    created_at   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by   VARCHAR(64)  NOT NULL,
    updated_at   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by   VARCHAR(64)  NOT NULL,

    CONSTRAINT ux_auth_role_code UNIQUE (role_code)
);

CREATE TABLE AUTH_ACCOUNT_ROLE
(
    auth_account_role_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id      BIGINT      NOT NULL,
    auth_role_id         BIGINT      NOT NULL,

    created_at           TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by           VARCHAR(64) NOT NULL,

    CONSTRAINT ux_auth_account_role UNIQUE (auth_account_id, auth_role_id),
    CONSTRAINT fk_auth_account_role_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id),
    CONSTRAINT fk_auth_account_role_role FOREIGN KEY (auth_role_id) REFERENCES AUTH_ROLE (auth_role_id)
);

CREATE TABLE AUTH_PASSWORD_HISTORY
(
    auth_password_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id          BIGINT       NOT NULL,

    password_hash            VARCHAR(512) NOT NULL,
    change_type              VARCHAR(32)  NOT NULL, -- INITIAL / USER_CHANGE / ADMIN_RESET 等

    changed_at               TIMESTAMP    NOT NULL,
    operated_by              VARCHAR(64)  NOT NULL, -- user_id / admin_id / SYSTEM

    created_at               TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by               VARCHAR(64)  NOT NULL,

    CONSTRAINT fk_auth_pwd_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id)
);

CREATE TABLE AUTH_LOGIN_HISTORY
(
    auth_login_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id       BIGINT      NOT NULL,

    result                VARCHAR(16) NOT NULL, -- SUCCESS / FAILURE / LOCKED / DISABLED / DELETED / EXPIRED 等
    login_at              TIMESTAMP   NOT NULL,

    created_at            TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by            VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_login_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id)
);

CREATE TABLE AUTH_ACCOUNT_LOCK_HISTORY
(
    auth_account_lock_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id              BIGINT      NOT NULL,

    locked                       BOOLEAN     NOT NULL,
    reason                       VARCHAR(64) NOT NULL,

    occurred_at                  TIMESTAMP   NOT NULL,
    operated_by                  VARCHAR(64) NOT NULL, -- admin_id / SYSTEM

    created_at                   TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by                   VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_lock_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id)
);

CREATE TABLE AUTH_ACCOUNT_EXPIRY_HISTORY
(
    auth_account_expiry_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id                BIGINT      NOT NULL,

    event_type                     VARCHAR(16) NOT NULL, -- EXPIRE / UNEXPIRE
    reason                         VARCHAR(64) NOT NULL,

    occurred_at                    TIMESTAMP   NOT NULL,
    operated_by                    VARCHAR(64) NOT NULL, -- admin_id / SYSTEM

    created_at                     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by                     VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_expiry_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id),
    CONSTRAINT ck_auth_expiry_hist_type CHECK (event_type IN ('EXPIRE', 'UNEXPIRE'))
);

CREATE TABLE AUTH_ACCOUNT_STATUS_HISTORY
(
    auth_account_status_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id                BIGINT      NOT NULL,

    from_status                    VARCHAR(16) NOT NULL,
    to_status                      VARCHAR(16) NOT NULL,
    reason                         VARCHAR(64) NOT NULL,

    occurred_at                    TIMESTAMP   NOT NULL,
    operated_by                    VARCHAR(64) NOT NULL,

    created_at                     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by                     VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_status_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id),
    CONSTRAINT ck_auth_status_hist_from CHECK (from_status IN ('ACTIVE', 'DISABLED', 'DELETED')),
    CONSTRAINT ck_auth_status_hist_to CHECK (to_status IN ('ACTIVE', 'DISABLED', 'DELETED'))
);

-- ==============
-- Indexes
-- ==============

CREATE INDEX ix_auth_account_status ON AUTH_ACCOUNT (account_status);
CREATE INDEX ix_auth_account_role_account ON AUTH_ACCOUNT_ROLE (auth_account_id);

CREATE INDEX ix_auth_pwd_hist_account_changed_desc
    ON AUTH_PASSWORD_HISTORY (auth_account_id, changed_at DESC, auth_password_history_id DESC);

CREATE INDEX ix_auth_login_hist_account_at_desc
    ON AUTH_LOGIN_HISTORY (auth_account_id, login_at DESC, auth_login_history_id DESC);

CREATE INDEX ix_auth_login_hist_account_result_at_desc
    ON AUTH_LOGIN_HISTORY (auth_account_id, result, login_at DESC);

CREATE INDEX ix_auth_lock_hist_account_occurred_desc
    ON AUTH_ACCOUNT_LOCK_HISTORY (auth_account_id, occurred_at DESC, auth_account_lock_history_id DESC);

CREATE INDEX ix_auth_lock_hist_account_locked_occurred_desc
    ON AUTH_ACCOUNT_LOCK_HISTORY (auth_account_id, locked, occurred_at DESC);

CREATE INDEX ix_auth_expiry_hist_account_occurred_desc
    ON AUTH_ACCOUNT_EXPIRY_HISTORY (auth_account_id, occurred_at DESC, auth_account_expiry_history_id DESC);

CREATE INDEX ix_auth_expiry_hist_account_event_occurred_desc
    ON AUTH_ACCOUNT_EXPIRY_HISTORY (auth_account_id, event_type, occurred_at DESC);

CREATE INDEX ix_auth_status_hist_account_occurred_desc
    ON AUTH_ACCOUNT_STATUS_HISTORY (auth_account_id, occurred_at DESC, auth_account_status_history_id DESC);

-- ==============
-- Views（Query sharedService）
-- ==============

/* --- Query sharedService 用 VIEW（PostgreSQL：DISTINCT ON） --- */

CREATE OR REPLACE VIEW AUTH_ACCOUNT_LOCK_LATEST_V AS
SELECT DISTINCT ON (auth_account_id)
    auth_account_id,
    locked,
    occurred_at
FROM AUTH_ACCOUNT_LOCK_HISTORY
ORDER BY auth_account_id,
    occurred_at DESC,
    auth_account_lock_history_id DESC;

CREATE OR REPLACE VIEW AUTH_ACCOUNT_EXPIRY_LATEST_V AS
SELECT DISTINCT ON (auth_account_id)
    auth_account_id,
    event_type,
    occurred_at
FROM AUTH_ACCOUNT_EXPIRY_HISTORY
ORDER BY auth_account_id,
    occurred_at DESC,
    auth_account_expiry_history_id DESC;

/* 期限解除（UNEXPIRE）の最新 */
CREATE OR REPLACE VIEW AUTH_ACCOUNT_LAST_UNEXPIRE_V AS
SELECT DISTINCT ON (auth_account_id)
    auth_account_id,
    occurred_at AS unexpire_at
FROM AUTH_ACCOUNT_EXPIRY_HISTORY
WHERE event_type = 'UNEXPIRE'
ORDER BY auth_account_id,
    occurred_at DESC,
    auth_account_expiry_history_id DESC;

/* 最終ログイン（SUCCESSの最新）※不要なら削除 */
CREATE OR REPLACE VIEW AUTH_ACCOUNT_LAST_LOGIN_V AS
SELECT DISTINCT ON (auth_account_id)
    auth_account_id,
    login_at
FROM AUTH_LOGIN_HISTORY
WHERE result = 'SUCCESS'
ORDER BY auth_account_id,
    login_at DESC,
    auth_login_history_id DESC;

CREATE OR REPLACE VIEW AUTH_ACCOUNT_CURRENT_V AS
SELECT a.auth_account_id,
       a.user_id,
       a.account_status,
       COALESCE(l.locked, FALSE)                  AS locked,
       COALESCE((e.event_type = 'EXPIRE'), FALSE) AS expired,
       ll.login_at                                AS last_login_at,

       /* 有効期限切れ年月日（baseAt=max(last_login_at,last_unexpire_at) + 90日） */
       CASE
           WHEN ll.login_at IS NULL AND lu.unexpire_at IS NULL THEN NULL
           WHEN ll.login_at IS NULL THEN (lu.unexpire_at + INTERVAL '90 days')::date
           WHEN lu.unexpire_at IS NULL THEN (ll.login_at + INTERVAL '90 days')::date
           ELSE (GREATEST(ll.login_at, lu.unexpire_at) + INTERVAL '90 days')::date
       END AS expiry_due_date,

       a.created_at,
       a.updated_at
FROM AUTH_ACCOUNT a
         LEFT JOIN AUTH_ACCOUNT_LOCK_LATEST_V l ON l.auth_account_id = a.auth_account_id
         LEFT JOIN AUTH_ACCOUNT_EXPIRY_LATEST_V e ON e.auth_account_id = a.auth_account_id
         LEFT JOIN AUTH_ACCOUNT_LAST_LOGIN_V ll ON ll.auth_account_id = a.auth_account_id
         LEFT JOIN AUTH_ACCOUNT_LAST_UNEXPIRE_V lu ON lu.auth_account_id = a.auth_account_id;

CREATE OR REPLACE VIEW AUTH_ACCOUNT_ROLE_V AS
SELECT aar.auth_account_id,
       r.role_code
FROM AUTH_ACCOUNT_ROLE aar
         JOIN AUTH_ROLE r
              ON r.auth_role_id = aar.auth_role_id
WHERE r.enabled = TRUE;
```

---

## 2. H2（開発用）DDL

```sql
/* =========================================================
 * H2（開発用）
 * ========================================================= */

-- ==============
-- Tables
-- ==============

CREATE TABLE AUTH_ACCOUNT
(
    auth_account_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    user_id         VARCHAR(64)  NOT NULL,
    password_hash   VARCHAR(512) NOT NULL,

    -- ライフサイクル状態（enabled/deleted を統合）
    account_status  VARCHAR(16)  NOT NULL DEFAULT 'ACTIVE',

    created_at      TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(64)  NOT NULL,

    updated_at      TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by      VARCHAR(64)  NOT NULL,

    -- 同時更新対策（任意だが推奨）
    version         INTEGER      NOT NULL DEFAULT 0,

    CONSTRAINT ux_auth_account_user_id UNIQUE (user_id),
    CONSTRAINT ck_auth_account_status CHECK (account_status IN ('ACTIVE', 'DISABLED', 'DELETED'))
);

CREATE TABLE AUTH_ROLE
(
    auth_role_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_code    VARCHAR(64)  NOT NULL,
    role_name    VARCHAR(128) NOT NULL,
    enabled      BOOLEAN      NOT NULL DEFAULT TRUE,

    created_at   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by   VARCHAR(64)  NOT NULL,
    updated_at   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by   VARCHAR(64)  NOT NULL,

    CONSTRAINT ux_auth_role_code UNIQUE (role_code)
);

CREATE TABLE AUTH_ACCOUNT_ROLE
(
    auth_account_role_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id      BIGINT      NOT NULL,
    auth_role_id         BIGINT      NOT NULL,

    created_at           TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by           VARCHAR(64) NOT NULL,

    CONSTRAINT ux_auth_account_role UNIQUE (auth_account_id, auth_role_id),
    CONSTRAINT fk_auth_account_role_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id),
    CONSTRAINT fk_auth_account_role_role FOREIGN KEY (auth_role_id) REFERENCES AUTH_ROLE (auth_role_id)
);

CREATE TABLE AUTH_PASSWORD_HISTORY
(
    auth_password_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id          BIGINT       NOT NULL,

    password_hash            VARCHAR(512) NOT NULL,
    change_type              VARCHAR(32)  NOT NULL, -- INITIAL / USER_CHANGE / ADMIN_RESET 等

    changed_at               TIMESTAMP    NOT NULL,
    operated_by              VARCHAR(64)  NOT NULL, -- user_id / admin_id / SYSTEM

    created_at               TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by               VARCHAR(64)  NOT NULL,

    CONSTRAINT fk_auth_pwd_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id)
);

CREATE TABLE AUTH_LOGIN_HISTORY
(
    auth_login_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id       BIGINT      NOT NULL,

    result                VARCHAR(16) NOT NULL, -- SUCCESS / FAILURE / LOCKED / DISABLED / DELETED / EXPIRED 等
    login_at              TIMESTAMP   NOT NULL,

    created_at            TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by            VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_login_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id)
);

CREATE TABLE AUTH_ACCOUNT_LOCK_HISTORY
(
    auth_account_lock_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id              BIGINT      NOT NULL,
    locked                       BOOLEAN     NOT NULL,
    reason                       VARCHAR(64) NOT NULL,

    occurred_at                  TIMESTAMP   NOT NULL,
    operated_by                  VARCHAR(64) NOT NULL, -- admin_id / SYSTEM

    created_at                   TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by                   VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_lock_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id)
);

CREATE TABLE AUTH_ACCOUNT_EXPIRY_HISTORY
(
    auth_account_expiry_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id                BIGINT      NOT NULL,

    event_type                     VARCHAR(16) NOT NULL, -- EXPIRE / UNEXPIRE
    reason                         VARCHAR(64) NOT NULL,

    occurred_at                    TIMESTAMP   NOT NULL,
    operated_by                    VARCHAR(64) NOT NULL, -- admin_id / SYSTEM

    created_at                     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by                     VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_expiry_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id),
    CONSTRAINT ck_auth_expiry_hist_type CHECK (event_type IN ('EXPIRE', 'UNEXPIRE'))
);

CREATE TABLE AUTH_ACCOUNT_STATUS_HISTORY
(
    auth_account_status_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_account_id                BIGINT      NOT NULL,

    from_status                    VARCHAR(16) NOT NULL,
    to_status                      VARCHAR(16) NOT NULL,
    reason                         VARCHAR(64) NOT NULL,

    occurred_at                    TIMESTAMP   NOT NULL,
    operated_by                    VARCHAR(64) NOT NULL,

    created_at                     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by                     VARCHAR(64) NOT NULL,

    CONSTRAINT fk_auth_status_hist_account FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT (auth_account_id),
    CONSTRAINT ck_auth_status_hist_from CHECK (from_status IN ('ACTIVE', 'DISABLED', 'DELETED')),
    CONSTRAINT ck_auth_status_hist_to CHECK (to_status IN ('ACTIVE', 'DISABLED', 'DELETED'))
);

-- ==============
-- Indexes
-- ==============

CREATE INDEX ix_auth_account_status ON AUTH_ACCOUNT (account_status);
CREATE INDEX ix_auth_account_role_account ON AUTH_ACCOUNT_ROLE (auth_account_id);
CREATE INDEX ix_auth_pwd_hist_account_changed_desc
    ON AUTH_PASSWORD_HISTORY (auth_account_id, changed_at, auth_password_history_id);
CREATE INDEX ix_auth_login_hist_account_at_desc
    ON AUTH_LOGIN_HISTORY (auth_account_id, login_at, auth_login_history_id);
CREATE INDEX ix_auth_login_hist_account_result_at_desc
    ON AUTH_LOGIN_HISTORY (auth_account_id, result, login_at);
CREATE INDEX ix_auth_lock_hist_account_occurred_desc
    ON AUTH_ACCOUNT_LOCK_HISTORY (auth_account_id, occurred_at, auth_account_lock_history_id);
CREATE INDEX ix_auth_lock_hist_account_locked_occurred_desc
    ON AUTH_ACCOUNT_LOCK_HISTORY (auth_account_id, locked, occurred_at);
CREATE INDEX ix_auth_expiry_hist_account_occurred_desc
    ON AUTH_ACCOUNT_EXPIRY_HISTORY (auth_account_id, occurred_at, auth_account_expiry_history_id);
CREATE INDEX ix_auth_expiry_hist_account_event_occurred_desc
    ON AUTH_ACCOUNT_EXPIRY_HISTORY (auth_account_id, event_type, occurred_at);
CREATE INDEX ix_auth_status_hist_account_occurred_desc
    ON AUTH_ACCOUNT_STATUS_HISTORY (auth_account_id, occurred_at, auth_account_status_history_id);

-- ==============
-- Views（Query sharedService）
-- ==============

/* --- Query sharedService 用 VIEW（H2：row_number） --- */

DROP VIEW IF EXISTS AUTH_ACCOUNT_LOCK_LATEST_V;
CREATE VIEW AUTH_ACCOUNT_LOCK_LATEST_V AS
SELECT auth_account_id, locked, occurred_at
FROM (SELECT auth_account_id,
             locked,
             occurred_at,
             ROW_NUMBER() OVER (
           PARTITION BY auth_account_id
           ORDER BY occurred_at DESC, auth_account_lock_history_id DESC
         ) AS rn
      FROM AUTH_ACCOUNT_LOCK_HISTORY) t
WHERE t.rn = 1;

DROP VIEW IF EXISTS AUTH_ACCOUNT_EXPIRY_LATEST_V;
CREATE VIEW AUTH_ACCOUNT_EXPIRY_LATEST_V AS
SELECT auth_account_id, event_type, occurred_at
FROM (SELECT auth_account_id,
             event_type,
             occurred_at,
             ROW_NUMBER() OVER (
           PARTITION BY auth_account_id
           ORDER BY occurred_at DESC, auth_account_expiry_history_id DESC
         ) AS rn
      FROM AUTH_ACCOUNT_EXPIRY_HISTORY) t
WHERE t.rn = 1;

/* 期限解除（UNEXPIRE）の最新 */
DROP VIEW IF EXISTS AUTH_ACCOUNT_LAST_UNEXPIRE_V;
CREATE VIEW AUTH_ACCOUNT_LAST_UNEXPIRE_V AS
SELECT auth_account_id, unexpire_at
FROM (SELECT auth_account_id,
             occurred_at AS unexpire_at,
             ROW_NUMBER() OVER (
           PARTITION BY auth_account_id
           ORDER BY occurred_at DESC, auth_account_expiry_history_id DESC
         ) AS rn
      FROM AUTH_ACCOUNT_EXPIRY_HISTORY
      WHERE event_type = 'UNEXPIRE') t
WHERE t.rn = 1;

/* 最終ログイン（SUCCESSの最新）※不要なら削除 */
DROP VIEW IF EXISTS AUTH_ACCOUNT_LAST_LOGIN_V;
CREATE VIEW AUTH_ACCOUNT_LAST_LOGIN_V AS
SELECT auth_account_id, login_at
FROM (SELECT auth_account_id,
             login_at,
             ROW_NUMBER() OVER (
           PARTITION BY auth_account_id
           ORDER BY login_at DESC, auth_login_history_id DESC
         ) AS rn
      FROM AUTH_LOGIN_HISTORY
      WHERE result = 'SUCCESS') t
WHERE t.rn = 1;

DROP VIEW IF EXISTS AUTH_ACCOUNT_CURRENT_V;
CREATE VIEW AUTH_ACCOUNT_CURRENT_V AS
SELECT a.auth_account_id,
       a.user_id,
       a.account_status,
       COALESCE(l.locked, FALSE)                  AS locked,
       COALESCE((e.event_type = 'EXPIRE'), FALSE) AS expired,
       ll.login_at                                AS last_login_at,

       /* 有効期限切れ年月日（baseAt=max(last_login_at,last_unexpire_at) + 90日） */
       CASE
           WHEN ll.login_at IS NULL AND lu.unexpire_at IS NULL THEN NULL
           WHEN ll.login_at IS NULL THEN CAST(DATEADD('DAY', 90, lu.unexpire_at) AS DATE)
           WHEN lu.unexpire_at IS NULL THEN CAST(DATEADD('DAY', 90, ll.login_at) AS DATE)
           ELSE CAST(DATEADD('DAY', 90, CASE WHEN ll.login_at >= lu.unexpire_at THEN ll.login_at ELSE lu.unexpire_at END) AS DATE)
       END AS expiry_due_date,

       a.created_at,
       a.updated_at
FROM AUTH_ACCOUNT a
         LEFT JOIN AUTH_ACCOUNT_LOCK_LATEST_V l ON l.auth_account_id = a.auth_account_id
         LEFT JOIN AUTH_ACCOUNT_EXPIRY_LATEST_V e ON e.auth_account_id = a.auth_account_id
         LEFT JOIN AUTH_ACCOUNT_LAST_LOGIN_V ll ON ll.auth_account_id = a.auth_account_id
         LEFT JOIN AUTH_ACCOUNT_LAST_UNEXPIRE_V lu ON lu.auth_account_id = a.auth_account_id;

DROP VIEW IF EXISTS AUTH_ACCOUNT_ROLE_V;
CREATE VIEW AUTH_ACCOUNT_ROLE_V AS
SELECT aar.auth_account_id,
       r.role_code
FROM AUTH_ACCOUNT_ROLE aar
         JOIN AUTH_ROLE r
              ON r.auth_role_id = aar.auth_role_id
WHERE r.enabled = TRUE;
```
