# ログイン認証処理

## 概要
ログイン画面から入力されたユーザーIDとパスワードを用いて認証を行い、結果に応じた処理（画面遷移、履歴記録、ロック制御など）を行う。

## 処理フロー

### フローチャート
※各ステップの番号は、後述の「詳細仕様」の項番に対応しています。
※実線矢印（ラベルなし）は処理フロー、点線矢印（ラベルあり：Read/Create）はデータアクセスを表します。

```mermaid
flowchart TD
    subgraph Process [処理フロー]
        Start([開始]) --> Input["1-1. ログイン画面入力"]
        Input --> AuthCheck{"1-2. 認証チェック"}
        
        AuthCheck -- 成功 --> SuccessEvent["2-1. 成功イベント発行"]
        SuccessEvent --> RecordSuccess["2-1. 履歴記録: SUCCESS"]
        RecordSuccess --> PwdChangeCheck{"2-2. パスワード変更必須?"}
        PwdChangeCheck -- Yes --> RedirectPwdChange["2-2. パスワード変更画面へ"]
        PwdChangeCheck -- No --> RedirectMenu["2-2. メニュー画面へ"]
        
        AuthCheck -- 失敗 --> FailureEvent["3-1. 失敗イベント発行"]
        FailureEvent --> AccountExists{"3-1. アカウント存在?"}
        
        AccountExists -- No --> RedirectLogin["3-4. ログイン画面へ<br/>(エラー表示)"]
        
        AccountExists -- Yes --> StatusCheck{"3-2. 状態判定"}
        
        StatusCheck -- 期限切れ --> RecordExpired["3-2. 履歴記録: EXPIRED"]
        StatusCheck -- 無効 --> RecordDisabled["3-2. 履歴記録: DISABLED"]
        StatusCheck -- ロック中 --> RecordLocked["3-2. 履歴記録: LOCKED"]
        StatusCheck -- その他 --> RecordFail["3-2. 履歴記録: FAIL"]
        
        RecordExpired --> RedirectLogin
        RecordDisabled --> RedirectLogin
        RecordLocked --> RedirectLogin
        
        RecordFail --> LockCheck{"3-3. ロックアウト判定"}
        LockCheck -- ロック対象 --> RecordLockEvent["3-3. ロックイベント記録"]
        RecordLockEvent --> RedirectLogin
        LockCheck -- 対象外 --> RedirectLogin
    end

    subgraph Database [データベース]
        direction TB
        AuthAccount[(AUTH_ACCOUNT)]
        LoginHistory[(AUTH_LOGIN_HISTORY)]
        LockHistory[(AUTH_ACCOUNT_LOCK_HISTORY)]
        PwdHistory[(AUTH_PASSWORD_HISTORY)]
        
        %% 強制的に縦に並べるための不可視リンク
        AuthAccount ~~~ LoginHistory ~~~ LockHistory ~~~ PwdHistory
    end

    %% Data Access
    AuthCheck -. Read .-> AuthAccount
    AuthCheck -. Read .-> LockHistory
    
    RecordSuccess -. Create .-> LoginHistory
    RecordExpired -. Create .-> LoginHistory
    RecordDisabled -. Create .-> LoginHistory
    RecordLocked -. Create .-> LoginHistory
    RecordFail -. Create .-> LoginHistory
    
    PwdChangeCheck -. Read .-> AuthAccount
    PwdChangeCheck -. Read .-> PwdHistory
    
    LockCheck -. Read .-> LoginHistory
    RecordLockEvent -. Create .-> LockHistory
```

### シーケンス図

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant Browser as ブラウザ
    participant Filter as Spring Security Filter Chain
    participant Provider as DaoAuthenticationProvider
    participant UserDetailsService as AuthAccountDetailsService
    participant SuccessHandler as AuthAuthenticationSuccessHandler
    participant FailureHandler as AuthAuthenticationFailureHandler
    participant EventListener as AuthenticationEventListener
    participant SharedService as LoginProcessSharedService
    participant PwdService as PasswordChangeSharedService
    participant DB as データベース

    User->>Browser: ログイン画面表示
    Browser->>Filter: POST /login (username, password)
    
    Filter->>Provider: authenticate()
    
    Provider->>UserDetailsService: loadUserByUsername(username)
    UserDetailsService->>DB: アカウント情報取得 (AUTH_ACCOUNT, AUTH_ROLE, etc.)
    UserDetailsService->>DB: 履歴情報取得 (AUTH_LOGIN_HISTORY, AUTH_ACCOUNT_LOCK_HISTORY)
    UserDetailsService-->>Provider: UserDetails (AuthAccountDetails)
    
    Provider->>Provider: パスワード照合 (PasswordEncoder)
    Provider->>Provider: アカウント状態チェック (Enabled, Locked, Expired)

    alt 認証成功
        Provider-->>Filter: Authentication (Success)
        Filter->>EventListener: publish AuthenticationSuccessEvent
        EventListener->>SharedService: onLoginSuccess(userId)
        SharedService->>DB: ログイン履歴(SUCCESS) 登録
        
        Filter->>SuccessHandler: onAuthenticationSuccess()
        SuccessHandler->>PwdService: isPasswordChangeRequired()
        PwdService->>DB: パスワード履歴取得 (AUTH_PASSWORD_HISTORY)
        PwdService-->>SuccessHandler: result (true/false)
        
        alt 変更必須
             SuccessHandler->>Browser: リダイレクト (パスワード変更画面)
        else 変更不要
             SuccessHandler->>Browser: リダイレクト (メニュー画面)
        end

    else 認証失敗 (パスワード不一致 / アカウント無効 / ロック中 / 期限切れ)
        Provider-->>Filter: AuthenticationException
        Filter->>EventListener: publish AbstractAuthenticationFailureEvent
        EventListener->>SharedService: onLoginFailure(userId)
        
        SharedService->>DB: アカウント情報取得
        
        opt アカウントが存在する場合
            SharedService->>SharedService: 状態判定 (Expired / Disabled / Locked)
            
            alt Expired (期限切れ)
                SharedService->>DB: ログイン履歴(EXPIRED) 登録
            else Disabled (無効)
                SharedService->>DB: ログイン履歴(DISABLED) 登録
            else Locked (ロック中)
                SharedService->>DB: ログイン履歴(LOCKED) 登録
            else その他 (パスワード間違いなど)
                SharedService->>DB: ログイン履歴(FAIL) 登録
                SharedService->>DB: 直近履歴取得
                SharedService->>SharedService: ロック判定 (LockPolicy)
                opt ロック対象
                    SharedService->>DB: ロック履歴(LOCK) 登録
                end
            end
        end

        Filter->>FailureHandler: onAuthenticationFailure()
        FailureHandler->>Browser: リダイレクト (ログイン画面 + エラーパラメータ)
    end
```

## 詳細仕様

### 1. 認証処理 (Spring Security)

#### 1-1. ログイン画面入力
*   **URL**: `/login` (POST)
*   **パラメータ**:
    *   `username`: ユーザーID
    *   `password`: パスワード

#### 1-2. 認証チェック
*   **認証プロバイダ**: `DaoAuthenticationProvider` を使用。
*   **ユーザー情報取得**: `AuthAccountDetailsService` にてDBからアカウント情報を取得し、`AuthAccountDetails` を生成する。
    *   `AuthAccountDetails` には、アカウントの有効状態、ロック状態、パスワード期限切れ状態、前回ログイン日時などが含まれる。
    *   ロック状態は `AUTH_ACCOUNT_LOCK_HISTORY` テーブルの履歴から判定する。
    *   有効期限切れは `AccountExpirySharedService` を利用して判定する。
*   **検証**: パスワード照合、およびアカウント状態（有効/ロック/期限切れ）のチェックを行う。

### 2. 認証成功時の処理

#### 2-1. 成功イベント発行・履歴記録
*   **イベントリスナー**: `AuthenticationSuccessEventListener` が `AuthenticationSuccessEvent` を検知。
*   **ドメイン処理**: `LoginProcessSharedService.onLoginSuccess(userId)` を実行。
    *   `AUTH_LOGIN_HISTORY` テーブルに `SUCCESS` の履歴を登録する。

#### 2-2. パスワード変更必須チェック・画面遷移
*   **ハンドラ**: `AuthAuthenticationSuccessHandler` が実行される。
    *   `PasswordChangeSharedService.requirementOf()` を呼び出し、パスワード変更が必要か判定する。
    *   **判定ロジック**:
        *   `AUTH_ACCOUNT` からユーザ情報を取得。
        *   `AUTH_PASSWORD_HISTORY` から最新のパスワード履歴を取得。
        *   履歴が存在しない場合（初期登録）、または変更種別が `ADMIN_RESET`（管理者リセット）の場合、または `USER_CHANGE` だが有効期限切れの場合に変更必須と判定する。
    *   **変更が必要な場合**: パスワード変更画面 (`/.well-known/change-password`) へリダイレクト。
    *   **変更不要な場合**: デフォルトの遷移先（メニュー画面など）へリダイレクト。

### 3. 認証失敗時の処理

#### 3-1. 失敗イベント発行・アカウント存在チェック
*   **イベントリスナー**: `AuthenticationFailureEventListener` が `AbstractAuthenticationFailureEvent` を検知。
*   **ドメイン処理**: `LoginProcessSharedService.onLoginFailure(userId)` を実行。
    *   入力された `userId` に該当するアカウントが存在しない場合は、セキュリティ保護のため履歴を残さず終了する。

#### 3-2. 状態判定・履歴記録
*   アカウントが存在する場合、その状態に応じて以下の履歴を `AUTH_LOGIN_HISTORY` に登録する。
    *   **期限切れ**: `EXPIRED`
    *   **無効**: `DISABLED`
    *   **ロック中**: `LOCKED` (失敗回数にはカウントしない)
    *   **その他 (パスワード間違い)**: `FAIL`

#### 3-3. ロックアウト判定・ロックイベント記録
*   履歴が `FAIL` の場合、直近のログイン履歴を取得し、`LockPolicy` に基づいてロックアウト判定を行う。
    *   ロックアウト条件（例: 連続6回失敗）を満たした場合、`AUTH_ACCOUNT_LOCK_HISTORY` に `LOCK` イベントを登録する。

#### 3-4. エラー画面遷移
*   **ハンドラ**: `AuthAuthenticationFailureHandler` が実行される。
    *   発生した例外 (`AccountExpiredException`, `LockedException`, `DisabledException` 等) に応じてエラーキーを決定する。
    *   ログイン画面 (`/login`) にエラーキーをパラメータとして付与してリダイレクトする（例: `/login?error=locked`）。

## 関連クラス
*   `AuthAccountDetailsService`
*   `AuthAuthenticationSuccessHandler`
*   `AuthAuthenticationFailureHandler`
*   `AuthenticationSuccessEventListener`
*   `AuthenticationFailureEventListener`
*   `LoginProcessSharedService` (Impl)
*   `PasswordChangeSharedService` (Impl)
*   `AuthAccountDetails`
