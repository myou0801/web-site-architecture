# 環境別の実値確定表（認証基盤） v1.1
更新日: 2026-01-25

本ファイルは、認証基盤の設定値を **Dev / IT(ST) / Prod** で確定し、運用・業務・基盤の合意を残すための確定表である。
Secretsは本ファイルに **平文を記載しない**（値は参照ID/格納先のみ記載）。

---

## 1. 環境定義
- Dev: 開発環境（個人/チーム）
- IT/ST: 結合・総合試験（本番相当検証）
- Prod: 本番環境

---

## 2. プロパティ実値（非Secrets）

| Key | Dev | IT/ST | Prod | 管理主体 | 備考 |
|---|---:|---:|---:|---|---|
| auth.post-login-success-url | /menu | /menu | /menu | 業務/運用 | ログイン成功後の業務メニューURL |
| auth.session.max-sessions | 1 | 1 | 1 | 基盤/運用 | U-07 推奨方針 |
| auth.session.absolute-timeout-hours | 8 | 8 | 8 | 基盤/運用 | D-08: 絶対タイムアウト（ログインへリダイレクト） |
| auth.web.forwarded-header.enabled | false | true | true | 基盤 | LB配下はtrue |
| auth.web.correlation-id.header | X-Correlation-Id | X-Correlation-Id | X-Correlation-Id | 基盤 | D-06 |
| auth.web.correlation-id.generate-if-absent | true | true | true | 基盤 |  |
| auth.audit.login-success.enabled | false | false | false/TBD | 運用/監査 | D-02: 既定OFF。要件時のみON |
| auth.password.history-count | 3 | 3 | 3 | 基盤 |  |
| auth.password.min-length | 12 | 12 | 12 | 基盤 |  |
| auth.password.max-length | 64 | 64 | 64 | 基盤 |  |
| auth.password.require-alpha | true | true | true | 基盤 |  |
| auth.password.require-digit | true | true | true | 基盤 |  |
| auth.password.prohibit-include-login-id | true | true | true | 基盤 |  |
| auth.password.prohibit-seq-length | 3 | 3 | 3 | 基盤 |  |
| auth.password.prohibit-repeat-length | 4 | 4 | 4 | 基盤 |  |

---

## 3. Secrets（格納先のみ記載）

| Key | Dev 格納先 | IT/ST 格納先 | Prod 格納先 | 管理主体 | ローテ方針 | 備考 |
|---|---|---|---|---|---|---|
| auth.audit.loginId.hmac-secret | 任意 | 任意 | 任意 | 運用/基盤 | **必要時のみ** | 平文を設定ファイルに置かない。キー変更日は運用記録し期間分割運用 |
| auth.initial-password-hash | 任意 | 任意 | 任意 | 運用/基盤 | 必要時のみ | bcrypt hash（平文初期PWは保持しない） |

### 3.1 bcrypt hash 作成手順（例）
- 目的: `auth.initial-password-hash` に設定するbcrypt hashを作る（平文は保持しない）
- 手順例（ローカルで生成→Secretsへ登録）:
  1. 運用で「初期PW平文」を決定（扱いは一時的）
  2. bcrypt cost（例: 10/12）を決定（詳細設計 D-07）
  3. ツールで hash を生成（生成結果のみをSecretsへ登録）
  4. 平文は破棄（運用記録に残さない）

---

## 4. 決定ログ（合意記録）

| 項目 | 決定 | 決定日 | 決定者 | 備考 |
|---|---|---|---|---|
| operatedBy | loginId（= user_id） | 2026-01-25 | TBD | 管理者操作の監査ログ項目 |
| LOGIN_SUCCESS監査 | default OFF | 2026-01-25 | TBD | `auth.audit.login-success.enabled=false` |
| 絶対タイムアウトUX | /login?reason=timeout へリダイレクト | 2026-01-25 | TBD | MSG-SES-ERR-001 |
| HMACキー運用 | 必要時のみローテ | 2026-01-25 | TBD | キー変更日で期間分割運用 |
| H2互換VIEW | DDL分離管理 | 2026-01-25 | TBD | UT側DDLで差分吸収 |

---

## 5. 次アクション（この表を確定するために必要な入力）
- 業務: `auth.post-login-success-url` の環境別実URL（Dev/IT/Prod）
- 基盤/運用: `auth.session.absolute-timeout-hours` の IT/ST・Prod 実値
- 運用/基盤: Secrets格納先（サービス名・キー名・参照ID）を確定

### 3.2 Secretsを任意とする場合の扱い（注意）

- `auth.audit.loginId.hmac-secret` を未設定の場合:
  - NOT_FOUND loginId のHMAC化ができないため、監査ログでは `UNCONFIGURED` 等の固定表現で出力する（生値は出力しない）。
  - 監査・不正アクセス調査の粒度が低下するため、本番では設定を推奨する。
- `auth.initial-password-hash` を未設定の場合:
  - 初期PW運用（U-09）が成立しないため、管理者による新規登録/初期化機能を提供しない、または登録時にエラーとする。
  - 本番運用で管理者登録/初期化を行う場合は設定が必要。
