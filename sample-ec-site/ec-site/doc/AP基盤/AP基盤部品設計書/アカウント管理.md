# アカウント管理 (AuthAccountAdminSharedService)

## 概要
管理者によるアカウントのライフサイクル管理（登録、パスワードリセット、ロック解除、有効化/無効化、削除）を提供する SharedService。

## メソッド一覧

1.  [registerAccount](#1-registeraccount) - アカウント新規登録
2.  [resetPassword](#2-resetpassword) - パスワードリセット
3.  [unlockAccount](#3-unlockaccount) - アカウントロック解除
4.  [disableAccount](#4-disableaccount) - アカウント無効化
5.  [enableAccount](#5-enableaccount) - アカウント有効化
6.  [deleteAccount](#6-deleteaccount) - アカウント論理削除

---

## 1. registerAccount

### 概要
新しいアカウントを作成し、初期パスワードとロールを設定する。

### シグネチャ
`AuthAccountId registerAccount(String newLoginId, Set<RoleCode> roleCodes)`

### 処理フロー

```mermaid
flowchart TD
    subgraph Process [処理フロー]
        Start([開始]) --> HashPwd[初期パスワードハッシュ化]
        HashPwd --> CreateAccount[AuthAccount生成]
        CreateAccount --> SaveAccount[AUTH_ACCOUNT登録]
        SaveAccount --> GetId[ID採番確認]
        
        GetId --> LoopRole{ロール数分ループ}
        LoopRole -- 次あり --> AddRole[AUTH_ACCOUNT_ROLE登録]
        AddRole --> LoopRole
        
        LoopRole -- 終了 --> RecordPwdHistory["パスワード履歴登録<br/>(INITIAL_REGISTER)"]
        RecordPwdHistory --> RecordStatusHistory["ステータス履歴登録<br/>(REGISTER_ACCOUNT)"]
        
        RecordStatusHistory --> End([終了])
    end

    subgraph Database [データベース]
        direction TB
        AuthAccount[(AUTH_ACCOUNT)]
        AuthRole[(AUTH_ACCOUNT_ROLE)]
        PwdHistory[(AUTH_PASSWORD_HISTORY)]
        StatusHistory[(AUTH_ACCOUNT_STATUS_HISTORY)]
        
        AuthAccount ~~~ AuthRole ~~~ PwdHistory ~~~ StatusHistory
    end

    %% Data Access
    SaveAccount -. Create .-> AuthAccount
    GetId -. Read .-> AuthAccount
    AddRole -. Create .-> AuthRole
    RecordPwdHistory -. Create .-> PwdHistory
    RecordStatusHistory -. Create .-> StatusHistory
```

### 詳細仕様
1.  **初期パスワード生成**: 設定値 `auth.initial-password` (デフォルト: `password123`) をハッシュ化する。
2.  **アカウント保存**: `AUTH_ACCOUNT` に新規レコードを登録する。
3.  **ロール付与**: 引数で指定されたロール一覧を `AUTH_ACCOUNT_ROLE` に登録する。
4.  **パスワード履歴登録**: `AUTH_PASSWORD_HISTORY` に変更種別 `INITIAL_REGISTER` で履歴を登録する。
5.  **ステータス履歴登録**: `AUTH_ACCOUNT_STATUS_HISTORY` に理由 `REGISTER_ACCOUNT` で履歴を登録する。

---

## 2. resetPassword

### 概要
指定されたアカウントのパスワードを初期パスワードにリセットし、同時にロックも解除する。

### シグネチャ
`void resetPassword(AuthAccountId targetAccountId)`

### 処理フロー

```mermaid
flowchart TD
    subgraph Process [処理フロー]
        Start([開始]) --> GetAccount[アカウント取得]
        GetAccount --> Exists{存在?}
        Exists -- No --> Error[例外送出]
        
        Exists -- Yes --> HashPwd[初期パスワードハッシュ化]
        HashPwd --> UpdateAccount[AUTH_ACCOUNT更新]
        
        UpdateAccount --> RecordPwdHistory["パスワード履歴登録<br/>(ADMIN_RESET)"]
        RecordPwdHistory --> RecordUnlock["ロック解除イベント登録<br/>(ADMIN_RESET_AND_UNLOCK)"]
        
        RecordUnlock --> End([終了])
    end

    subgraph Database [データベース]
        direction TB
        AuthAccount[(AUTH_ACCOUNT)]
        PwdHistory[(AUTH_PASSWORD_HISTORY)]
        LockHistory[(AUTH_ACCOUNT_LOCK_HISTORY)]
        
        AuthAccount ~~~ PwdHistory ~~~ LockHistory
    end

    %% Data Access
    GetAccount -. Read .-> AuthAccount
    UpdateAccount -. Update .-> AuthAccount
    RecordPwdHistory -. Create .-> PwdHistory
    RecordUnlock -. Create .-> LockHistory
```

### 詳細仕様
1.  **アカウント取得**: 対象アカウントが存在しない場合は例外とする。
2.  **パスワード更新**: 初期パスワードのハッシュ値で `AUTH_ACCOUNT` を更新する。
3.  **パスワード履歴登録**: `AUTH_PASSWORD_HISTORY` に変更種別 `ADMIN_RESET` で履歴を登録する。
4.  **ロック解除**: `AUTH_ACCOUNT_LOCK_HISTORY` に `UNLOCK` イベントを登録する（パスワード初期化時はロックも解除する仕様のため）。

---

## 3. unlockAccount

### 概要
ロック状態のアカウントを強制的にロック解除する。

### シグネチャ
`void unlockAccount(AuthAccountId targetAccountId)`

### 処理フロー

```mermaid
flowchart TD
    subgraph Process [処理フロー]
        Start([開始]) --> GetAccount[アカウント取得]
        GetAccount --> CheckLock[ロック状態判定]
        
        CheckLock -- ロック中ではない --> End([終了])
        
        CheckLock -- ロック中 --> RecordUnlock["ロック解除イベント登録<br/>(ADMIN_UNLOCK)"]
        RecordUnlock --> End
    end

    subgraph Database [データベース]
        direction TB
        AuthAccount[(AUTH_ACCOUNT)]
        LockHistory[(AUTH_ACCOUNT_LOCK_HISTORY)]
        
        AuthAccount ~~~ LockHistory
    end

    %% Data Access
    GetAccount -. Read .-> AuthAccount
    CheckLock -. Read .-> LockHistory
    RecordUnlock -. Create .-> LockHistory
```

### 詳細仕様
1.  **アカウント取得**: 対象アカウントが存在しない場合は例外とする。
2.  **ロック状態判定**: 直近のロック履歴から現在ロック中か判定する。ロック中でなければ処理を終了する（イベント重複防止）。
3.  **ロック解除**: `AUTH_ACCOUNT_LOCK_HISTORY` に `UNLOCK` イベントを登録する。

---

## 4. disableAccount

### 概要
アカウントを無効化（ログイン不可）する。

### シグネチャ
`void disableAccount(AuthAccountId targetAccountId)`

### 処理フロー

```mermaid
flowchart TD
    subgraph Process [処理フロー]
        Start([開始]) --> GetAccount[アカウント取得]
        GetAccount --> CheckStatus{無効化可能?}
        
        CheckStatus -- "No (既に無効/削除済)" --> End([終了])
        
        CheckStatus -- Yes --> UpdateAccount["AUTH_ACCOUNT更新<br/>(accountStatus=DISABLED)"]
        UpdateAccount --> RecordStatus["ステータス履歴登録<br/>(DISABLE_ACCOUNT)"]
        
        RecordStatus --> End
    end

    subgraph Database [データベース]
        direction TB
        AuthAccount[(AUTH_ACCOUNT)]
        StatusHistory[(AUTH_ACCOUNT_STATUS_HISTORY)]
        
        AuthAccount ~~~ StatusHistory
    end

    %% Data Access
    GetAccount -. Read .-> AuthAccount
    UpdateAccount -. Update .-> AuthAccount
    RecordStatus -. Create .-> StatusHistory
```

### 詳細仕様
1.  **アカウント取得**: 対象アカウントが存在しない場合は例外とする。
2.  **状態チェック**: 既に無効化されている、または削除済みの場合は処理を終了する。
3.  **アカウント更新**: `AUTH_ACCOUNT.account_status` を `DISABLED` に更新する。
4.  **ステータス履歴登録**: `AUTH_ACCOUNT_STATUS_HISTORY` に理由 `DISABLE_ACCOUNT` で履歴を登録する。

---

## 5. enableAccount

### 概要
無効化されたアカウントを有効化する。有効期限切れの場合は期限切れ解除も行う。

### シグネチャ
`void enableAccount(AuthAccountId targetAccountId)`

### 処理フロー

```mermaid
flowchart TD
    subgraph Process [処理フロー]
        Start([開始]) --> GetAccount[アカウント取得]
        GetAccount --> Unexpire[有効期限切れ解除]
        
        Unexpire --> CheckStatus{有効化可能?}
        
        CheckStatus -- "No (既に有効/削除済)" --> End([終了])
        
        CheckStatus -- Yes --> UpdateAccount["AUTH_ACCOUNT更新<br/>(accountStatus=ACTIVE)"]
        UpdateAccount --> RecordStatus["ステータス履歴登録<br/>(ENABLE_ACCOUNT)"]
        
        RecordStatus --> End
    end

    subgraph Database [データベース]
        direction TB
        AuthAccount[(AUTH_ACCOUNT)]
        StatusHistory[(AUTH_ACCOUNT_STATUS_HISTORY)]
        ExpiryHistory[(AUTH_ACCOUNT_EXPIRY_HISTORY)]
        
        AuthAccount ~~~ StatusHistory ~~~ ExpiryHistory
    end

    %% Data Access
    GetAccount -. Read .-> AuthAccount
    Unexpire -. Read/Create .-> ExpiryHistory
    UpdateAccount -. Update .-> AuthAccount
    RecordStatus -. Create .-> StatusHistory
```

### 詳細仕様
1.  **アカウント取得**: 対象アカウントが存在しない場合は例外とする。
2.  **有効期限切れ解除**: `AccountExpirySharedService.unexpireIfExpired` を呼び出し、期限切れ状態であれば解除履歴を登録する。
3.  **状態チェック**: 既に有効、または削除済みの場合は処理を終了する。
4.  **アカウント更新**: `AUTH_ACCOUNT.account_status` を `ACTIVE` に更新する。
5.  **ステータス履歴登録**: `AUTH_ACCOUNT_STATUS_HISTORY` に理由 `ENABLE_ACCOUNT` で履歴を登録する。

---

## 6. deleteAccount

### 概要
アカウントを論理削除する。

### シグネチャ
`void deleteAccount(AuthAccountId targetAccountId)`

### 処理フロー

```mermaid
flowchart TD
    subgraph Process [処理フロー]
        Start([開始]) --> GetAccount[アカウント取得]
        GetAccount --> CheckStatus{削除可能?}
        
        CheckStatus -- "No (既に削除済)" --> End([終了])
        
        CheckStatus -- Yes --> UpdateAccount["AUTH_ACCOUNT更新<br/>(accountStatus=DELETED)"]
        UpdateAccount --> RecordStatus["ステータス履歴登録<br/>(DELETE_ACCOUNT)"]
        
        RecordStatus --> End
    end

    subgraph Database [データベース]
        direction TB
        AuthAccount[(AUTH_ACCOUNT)]
        StatusHistory[(AUTH_ACCOUNT_STATUS_HISTORY)]
        
        AuthAccount ~~~ StatusHistory
    end

    %% Data Access
    GetAccount -. Read .-> AuthAccount
    UpdateAccount -. Update .-> AuthAccount
    RecordStatus -. Create .-> StatusHistory
```

### 詳細仕様
1.  **アカウント取得**: 対象アカウントが存在しない場合は例外とする。
2.  **状態チェック**: 既に削除済みの場合は処理を終了する。
3.  **アカウント更新**: `AUTH_ACCOUNT.account_status` を `DELETED` に更新する。
    *   ※ `AUTH_ACCOUNT` テーブルには `deleted` カラムや `enabled` カラムは存在せず、`account_status` カラムで状態管理を行っている。
4.  **ステータス履歴登録**: `AUTH_ACCOUNT_STATUS_HISTORY` に理由 `DELETE_ACCOUNT` で履歴を登録する。
