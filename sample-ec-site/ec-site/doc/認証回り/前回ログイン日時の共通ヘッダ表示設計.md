ã‹ãªã‚Šã‚¢ãƒªãªè¨­è¨ˆã§ã™ ğŸ‘
ç‰¹ã«ã€Œ**å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ã”ã¨ã«1å›ã ã‘æ±ºã¾ã‚‹å€¤**ã€ãªã®ã§ã€

> âœ… èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ï¼ˆ`UserDetails` ã®å®Ÿè£…ï¼‰ã« `previousLoginAt` ã‚’æŒãŸã›ã¦
> ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã¯ãã‚Œã‚’ä½¿ã„å›ã™

ã®ã¯åˆç†çš„ã§ã™ã€‚

---

## æ–¹é‡ã¾ã¨ã‚

* **CustomUserDetails**ï¼ˆSpring Security ã® `User` æ‹¡å¼µ or `UserDetails` å®Ÿè£…ï¼‰ã‚’ä½œã‚‹

    * `AuthUserId`
    * `loginId`
    * `previousLoginAt`
    * ï¼ˆå¿…è¦ãªã‚‰ displayName ç­‰ï¼‰ã‚’æŒãŸã›ã‚‹
* `AuthUserDetailsService` ã§

    * `AuthUserRepository` ã§ãƒ¦ãƒ¼ã‚¶ã‚’å–å¾—
    * `AuthAccountLockHistoryRepository` ã§ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ¤å®š
    * **`AuthLoginHistoryRepository.findPreviousSuccessLoginAt(userId)` ã§å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ±‚ã‚ã‚‹**
    * ãã‚Œã‚‰ã‚’ã‚‚ã¨ã« `CustomUserDetails` ã‚’ new ã™ã‚‹
* å…±é€šãƒ˜ãƒƒãƒ€ã¯

    * `SecurityContextHolder` ã‹ã‚‰ principal ã‚’å–ã‚Šå‡ºã—ã¦
    * `instanceof CustomUserDetails` ã§ã‚­ãƒ£ã‚¹ãƒˆã— `getPreviousLoginAt()` ã‚’è¡¨ç¤º
* DDD çš„ã«ã¯ï¼š

    * ã€Œå‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’ã©ã†å®šç¾©ã™ã‚‹ã‹ã€ã¯ domain / repository å´ã®è²¬å‹™
    * ãã®å€¤ã‚’ `UserDetails` ã«ã€Œã‚³ãƒ”ãƒ¼ã€ã—ã¦ãŠãã‚¤ãƒ¡ãƒ¼ã‚¸ãªã®ã§ã€ãƒ¬ã‚¤ãƒ¤ã®ç ´ç¶»ã¯ã—ãªã„

ãƒã‚¤ãƒ³ãƒˆã¯ã€`loadUserByUsername` ãŒå‘¼ã°ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã€Œãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã®å±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹å‰ã€ãªã®ã§
`findPreviousSuccessLoginAt` ã¯ã€Œä»Šå›ãƒ­ã‚°ã‚¤ãƒ³ã‚ˆã‚Šå‰ã®æˆåŠŸã€ã®æ—¥æ™‚ã‚’æ­£ã—ãè¿”ã—ã¦ãã‚Œã¾ã™ã€‚

---

## 1. CustomUserDetails ã®å®Ÿè£…

### ä¾‹ï¼š`AuthUserDetails`ï¼ˆUser ã‚’ç¶™æ‰¿ï¼‰

```java
package com.myou.ec.ecsite.application.auth.security;

import com.myou.ec.ecsite.domain.auth.model.value.AuthAccountId;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.User;

import java.time.LocalDateTime;
import java.util.Collection;

/**
 * èªè¨¼æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã€‚
 * Spring Security ã® User ã«ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æƒ…å ±ï¼ˆaccountId ç­‰ï¼‰ã¨å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’è¿½åŠ ã€‚
 */
public class AuthAccountDetails extends User {

    private final AuthAccountId authAccountId;
    private final LocalDateTime previousLoginAt;

    public AuthAccountDetails(AuthAccountId authAccountId,
                           String username,
                           String password,
                           boolean enabled,
                           boolean accountNonExpired,
                           boolean credentialsNonExpired,
                           boolean accountNonLocked,
                           Collection<? extends GrantedAuthority> authorities,
                           LocalDateTime previousLoginAt) {
        super(username, password, enabled, accountNonExpired, credentialsNonExpired, accountNonLocked, authorities);
        this.authAccountId = authAccountId;
        this.previousLoginAt = previousLoginAt;
    }

    public AuthAccountId authAccountId() {
        return authAccountId;
    }

    public LocalDateTime previousLoginAt() {
        return previousLoginAt;
    }
}
```

---

## 2. AuthUserDetailsService ã®ä¿®æ­£

`AuthLoginHistoryRepository` ã‚’æ³¨å…¥ã—ã€å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’å–å¾—ã—ã¦ `AuthUserDetails` ã«è©°ã‚ã¾ã™ã€‚

```java
package com.myou.ec.ecsite.application.auth.security;

import com.myou.ec.ecsite.domain.auth.model.AuthAccount;
import com.myou.ec.ecsite.domain.auth.model.AccountLockEvents;
import com.myou.ec.ecsite.domain.auth.model.value.AuthAccountId;
import com.myou.ec.ecsite.domain.auth.model.value.LockStatus;
import com.myou.ec.ecsite.domain.auth.model.value.UserId;
import com.myou.ec.ecsite.domain.auth.repository.AuthAccountLockHistoryRepository;
import com.myou.ec.ecsite.domain.auth.repository.AuthLoginHistoryRepository;
import com.myou.ec.ecsite.domain.auth.repository.AuthAccountRepository;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.*;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;

@Service
public class AuthAccountDetailsService implements UserDetailsService {

    private final AuthAccountRepository authAccountRepository;
    private final AuthAccountLockHistoryRepository lockHistoryRepository;
    private final AuthLoginHistoryRepository loginHistoryRepository;

    public AuthAccountDetailsService(AuthAccountRepository authAccountRepository,
                                  AuthAccountLockHistoryRepository lockHistoryRepository,
                                  AuthLoginHistoryRepository loginHistoryRepository) {
        this.authAccountRepository = authAccountRepository;
        this.lockHistoryRepository = lockHistoryRepository;
        this.loginHistoryRepository = loginHistoryRepository;
    }

    @Override
    public UserDetails loadUserByUsername(String username)
            throws UsernameNotFoundException {

        UserId userId = new UserId(username);
        AuthAccount user = authAccountRepository.findByUserId(userId)
                .orElseThrow(() -> new UsernameNotFoundException("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“: " + username));

        AuthAccountId accountId = user.id();

        // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®åˆ¤å®š
        boolean locked = false;
        if (accountId != null) {
            AccountLockEvents lockEvents = lockHistoryRepository.findByAccountId(accountId);
            locked = lockEvents.currentStatus() == LockStatus.LOCKED;
        }

        // å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ï¼ˆä»Šå›ãƒ­ã‚°ã‚¤ãƒ³ã‚ˆã‚Šå‰ã® SUCCESSï¼‰
        LocalDateTime previousLoginAt = null;
        if (accountId != null) {
            previousLoginAt = loginHistoryRepository
                    .findPreviousSuccessLoginAtByAccountId(accountId)
                    .map(LoginHistory::loginAt)
                    .orElse(null);
        }

        List<GrantedAuthority> authorities = user.roleCodes().stream()
                .map(rc -> new SimpleGrantedAuthority(rc.value()))
                .toList();

        boolean enabled = user.canLogin();     // ç„¡åŠ¹ãƒ•ãƒ©ã‚°ç­‰ã‚’è¦‹ã¦ã„ã‚‹æƒ³å®š
        boolean accountNonExpired = true;
        boolean credentialsNonExpired = true;
        boolean accountNonLocked = !locked;

        return new AuthAccountDetails(
                accountId,
                user.userId().value(),
                user.encodedPassword().value(),
                enabled,
                accountNonExpired,
                credentialsNonExpired,
                accountNonLocked,
                authorities,
                previousLoginAt
        );
    }
}```

ã“ã‚Œã§ã€

* ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼æ™‚ã« **1å›ã ã‘** DB ã‹ã‚‰å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’å–ã‚‹
* ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã¯ SecurityContext ã® principal ã«ä¿æŒã•ã‚ŒãŸå€¤ã‚’ä½¿ã†

ã¨ã„ã†å‹•ãã«ãªã‚Šã¾ã™ã€‚

---

## 3. å…±é€šãƒ˜ãƒƒãƒ€ã‹ã‚‰ã®åˆ©ç”¨ï¼ˆControllerAdviceï¼‰

`AuthUserContextSharedService` çµŒç”±ã§ã‚‚å–ã‚Œã¾ã™ãŒã€
å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã«é–¢ã—ã¦ã¯ **principal å„ªå…ˆ**ã§å–ã‚‹ã»ã†ãŒ DB è² è·ã‚‚æ¸›ã£ã¦ã‚¹ãƒƒã‚­ãƒªã§ã™ã€‚

```java
package com.myou.ec.ecsite.presentation.common.header;

import com.myou.ec.ecsite.application.auth.security.AuthUserDetails;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ModelAttribute;

import java.time.LocalDateTime;

@ControllerAdvice(annotations = Controller.class)
public class CommonHeaderControllerAdvice {

    @ModelAttribute("headerInfo")
    public HeaderInfo headerInfo() {

        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth == null || !auth.isAuthenticated()
                || "anonymousUser".equals(auth.getPrincipal())) {
            return null;
        }

        if (!(auth.getPrincipal() instanceof AuthAccountDetails userDetails)) {
            return null;
        }

        String userId = userDetails.getUsername();
        LocalDateTime previousLoginAt = userDetails.previousLoginAt();

        return new HeaderInfo(
                userId,
                null,            // displayName ç­‰ã¯å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µ
                previousLoginAt
        );
    }
}
```

Thymeleaf å´ã¯å…ˆã»ã©ã®æ¡ˆã¨åŒã˜ã§ã€`headerInfo.previousLoginAt` ã‚’è¡¨ç¤ºã™ã‚Œã°OKã§ã™ã€‚

---

## ã“ã®è¨­è¨ˆã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

### âœ… ãƒ¡ãƒªãƒƒãƒˆ

* å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã¯ **ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«ä¸å¤‰**ã§ã‚ã‚‹ã¹ãå€¤ãªã®ã§ã€`UserDetails` ã«æŒãŸã›ã‚‹ã®ã¯è‡ªç„¶
* å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã« DB ã¸å•ã„åˆã‚ã›ã‚‹å¿…è¦ãŒãªããªã‚‹ï¼ˆãƒ˜ãƒƒãƒ€è¡¨ç¤ºã®ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
* å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã®ç®—å‡ºãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯ `AuthLoginHistoryRepository` ã«æ®‹ã‚‹ã®ã§ã€

    * ã€Œæœ€å¾Œã® SUCCESS ã‚’ã©ã†å®šç¾©ã™ã‚‹ã‹ï¼Ÿã€ãªã©ã®ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¯ DDD çš„ã« domain å´ã«é–‰ã˜ã‚‹

### âš  ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ / æ³¨æ„ç‚¹

* `UserDetails` ãŒã€Œèªè¨¼æƒ…å ±ï¼‹ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ…å ±ã€ã®ãƒŸãƒƒã‚¯ã‚¹ã«ãªã‚‹ã®ã§ã€

    * å®Œå…¨ã«ã‚­ãƒ¬ã‚¤ãªãƒ¬ã‚¤ãƒ¤åˆ†é›¢ï¼ˆSecurity = infrastructureï¼‰ã‚’è¿½æ±‚ã™ã‚‹æµæ´¾ã ã¨å«ŒãŒã‚‹äººã‚‚ã„ã‚‹
    * ãŸã ã—ã€APåŸºç›¤ã§ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§ç¾å®Ÿçš„ã«ã¯è¨±å®¹ç¯„å›²ã ã¨æ€ã„ã¾ã™
* å°†æ¥ã€ã€ŒAPI ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã€ã€Œåˆ¥ã®èªè¨¼æ–¹å¼ã€ã§ã‚‚å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’ä½¿ã†å ´åˆã€

    * ãã®èªè¨¼æ–¹å¼ã§ã‚‚åŒæ§˜ã« `UserDetails` ã«è¼‰ã›ã‚‹ or åˆ¥ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§é‹ã¶è¨­è¨ˆãŒå¿…è¦

---

## çµè«–

> **ã€ŒSpring Security ã® Userï¼ˆUserDetailsï¼‰ã«å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æŒãŸã›ã‚‹ã€è¨­è¨ˆã¯ååˆ†ã‚¢ãƒªã§ã€ã‚€ã—ã‚å®Ÿç”¨çš„ãªé¸æŠè‚¢ã§ã™ã€‚**

ç‰¹ã«ä»Šå›ã®ã‚ˆã†ã«ï¼š

* èªè¨¼åŸºç›¤ã¨ç”»é¢å…±é€šãƒ˜ãƒƒãƒ€ã‚’ APåŸºç›¤TãŒã¾ã¨ã‚ã¦é¢å€’è¦‹ã‚‹
* å‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ã”ã¨ã«ä¸€åº¦ã ã‘æ±ºã¾ã‚‹å€¤ã€

ã¨ã„ã†å‰æãªã‚‰ã€**CustomUserDetails ã§æŒãŸã›ã‚‹æ¡ˆã¯ã‹ãªã‚Šã—ã£ãã‚Šãã‚‹**ã¨æ€ã„ã¾ã™ã€‚

ä»Šã® `AuthAccountContextSharedService` ã¯ãã®ã¾ã¾æ®‹ã—ã¦ãŠã„ã¦ã€

* ãƒ˜ãƒƒãƒ€è¡¨ç¤ºï¼š`AuthAccountDetails.previousLoginAt()`
* æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰ã€Œå‰å›ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã€ã‚’æœ¬å½“ã«å‚ç…§ã—ãŸã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Œã°ï¼š
  `AuthAccountContextSharedService.findPreviousLoginAt()` ã‚‚ä½¿ãˆã‚‹

ã¨ã„ã†äºŒæ®µæ§‹ãˆã«ã—ã¦ãŠãã¨ã€æŸ”è»Ÿæ€§ã‚‚é«˜ã„ã§ã™ã€‚
