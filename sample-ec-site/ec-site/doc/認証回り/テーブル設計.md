
# 認証系テーブル設計（DDL案＋役割・補足）

前提：

- 本番 DB: **PostgreSQL**
- 開発 DB: **H2（MODE=PostgreSQL）**
- 認証系テーブルは AP基盤（auth コンテキスト）が管理
- 業務側のユーザ情報（氏名・部署など）は USER_PROFILE など別テーブルで管理

---

## 1. AUTH_ACCOUNT（認証アカウント）

### 1.1 役割

- ログインに必要な **ユーザーID・パスワード・有効/削除状態** を保持する中核テーブル。
- ドメインの `AuthAccount` エンティティに対応。
- アカウント管理画面やログイン処理のほぼ全ての起点となる。

### 1.2 DDL

```sql
CREATE TABLE AUTH_ACCOUNT (
    AUTH_ACCOUNT_ID     BIGINT GENERATED BY DEFAULT AS IDENTITY,
    USER_ID             VARCHAR(100)    NOT NULL,           -- ユーザーID
    LOGIN_PASSWORD      VARCHAR(255)    NOT NULL,           -- ハッシュ済パスワード
    ENABLED_FLG         CHAR(1)         NOT NULL,           -- '1':有効, '0':無効
    DELETED_FLG         CHAR(1)         NOT NULL,           -- '1':削除, '0':未削除
    CREATED_AT          TIMESTAMP       NOT NULL,
    CREATED_BY          VARCHAR(100)    NOT NULL,
    UPDATED_AT          TIMESTAMP       NOT NULL,
    UPDATED_BY          VARCHAR(100)    NOT NULL,
    VERSION_NO          BIGINT          NOT NULL,

    CONSTRAINT PK_AUTH_ACCOUNT PRIMARY KEY (AUTH_ACCOUNT_ID),
    CONSTRAINT UQ_AUTH_ACCOUNT_USER_ID UNIQUE (USER_ID),
    CONSTRAINT CK_AUTH_ACCOUNT_ENABLED CHECK (ENABLED_FLG IN ('0', '1')),
    CONSTRAINT CK_AUTH_ACCOUNT_DELETED CHECK (DELETED_FLG IN ('0', '1'))
);
````

### 1.3 補足

* **AUTH_ACCOUNT_ID**

    * 認証ドメイン内でユーザを一意に識別する内部ID（`AuthAccountId`）。
    * USER_PROFILE 等、他テーブルからもこの ID を参照する。
* **USER_ID**

    * 画面から入力されるユーザーID（`UserId`）。
    * ロールによる命名規約（社員番号形式など）はドメイン・バリデーションでチェック。
* **LOGIN_PASSWORD**

    * ハッシュ済みパスワード（`EncodedPassword`）。
    * 生パスワードは永続化しない。
* **ENABLED_FLG / DELETED_FLG**

    * 有効／無効、論理削除の状態管理。
    * 削除は基本「無効 + DELETED=1」で表現し、履歴テーブルとの整合性を保ちやすくする想定。
* **VERSION_NO**

    * 楽観ロック用（更新時の競合検知）。

---

## 2. AUTH_ROLE（ロールマスタ）

### 2.1 役割

* システム内で使用するロール（権限グループ）のマスタ。
* ドメインの `AuthRole` に対応。
* Spring Security の `ROLE_◯◯` ともマッピングされる。

### 2.2 DDL

```sql
CREATE TABLE AUTH_ROLE (
    ROLE_CODE       VARCHAR(50)    NOT NULL,       -- 例: ROLE_ADMIN
    ROLE_NAME       VARCHAR(100)   NOT NULL,       -- 表示名
    SORT_ORDER      INTEGER        NOT NULL,
    CREATED_AT      TIMESTAMP      NOT NULL,
    CREATED_BY      VARCHAR(100)   NOT NULL,
    UPDATED_AT      TIMESTAMP      NOT NULL,
    UPDATED_BY      VARCHAR(100)   NOT NULL,
    VERSION_NO      BIGINT         NOT NULL,

    CONSTRAINT PK_AUTH_ROLE PRIMARY KEY (ROLE_CODE)
);
```

### 2.3 補足

* **ROLE_CODE**

    * 例：`ROLE_ADMIN`, `ROLE_USER` など。
    * Spring Security の `GrantedAuthority` として使う前提。
* **SORT_ORDER**

    * 管理画面での表示順などに利用可能。
* ロール数は多くない前提なので、インデックスは PK のみで十分。

---

## 3. AUTH_ACCOUNT_ROLE（アカウント–ロール関連）

### 3.1 役割

* どのアカウントにどのロールが付与されているかを管理。
* `AuthAccountRole` としてドメインで扱う。
* 1アカウント多ロール、1ロール多アカウントの N:M 関係テーブル。

### 3.2 DDL

```sql
CREATE TABLE AUTH_ACCOUNT_ROLE (
    AUTH_ACCOUNT_ID    BIGINT        NOT NULL,
    ROLE_CODE          VARCHAR(50)   NOT NULL,
    CREATED_AT         TIMESTAMP     NOT NULL,
    CREATED_BY         VARCHAR(100)  NOT NULL,

    CONSTRAINT PK_AUTH_ACCOUNT_ROLE PRIMARY KEY (AUTH_ACCOUNT_ID, ROLE_CODE),
    CONSTRAINT FK_AUTH_ACCOUNT_ROLE_USER FOREIGN KEY (AUTH_ACCOUNT_ID)
        REFERENCES AUTH_ACCOUNT (AUTH_ACCOUNT_ID),
    CONSTRAINT FK_AUTH_ACCOUNT_ROLE_ROLE FOREIGN KEY (ROLE_CODE)
        REFERENCES AUTH_ROLE (ROLE_CODE)
);
```

### 3.3 補足

* PK を `(AUTH_ACCOUNT_ID, ROLE_CODE)` の複合にすることで

    * 同じアカウントに同じロールを二重付与することを防止。
* Spring Security の `UserDetailsService` で、アカウントのロール一覧を取得するときに使用。

---

## 4. AUTH_PASSWORD_HISTORY（パスワード履歴）

### 4.1 役割

* パスワード変更履歴（初回登録・管理者初期化・ユーザ自身の変更）を管理。
* パスワード有効期限（90日）や再利用禁止（3世代）判定の基礎データ。
* ドメインの `PasswordHistory` + `PasswordChangeType` に対応。

### 4.2 DDL

```sql
CREATE TABLE AUTH_PASSWORD_HISTORY (
    AUTH_PASSWORD_HISTORY_ID   BIGINT GENERATED BY DEFAULT AS IDENTITY,
    AUTH_ACCOUNT_ID            BIGINT         NOT NULL,
    LOGIN_PASSWORD             VARCHAR(255)   NOT NULL,    -- ハッシュ済み
    CHANGE_TYPE                VARCHAR(20)    NOT NULL,    -- INITIAL_REGISTER / ADMIN_RESET / USER_CHANGE
    CHANGED_AT                 TIMESTAMP      NOT NULL,
    CHANGED_BY_USER_ID         VARCHAR(100)   NOT NULL,

    CREATED_AT                 TIMESTAMP      NOT NULL,
    CREATED_BY                 VARCHAR(100)   NOT NULL,

    CONSTRAINT PK_AUTH_PASSWORD_HISTORY PRIMARY KEY (AUTH_PASSWORD_HISTORY_ID),
    CONSTRAINT FK_AUTH_PASSWORD_HISTORY_USER FOREIGN KEY (AUTH_ACCOUNT_ID)
        REFERENCES AUTH_ACCOUNT (AUTH_ACCOUNT_ID),
    CONSTRAINT CK_AUTH_PASSWORD_CHANGE_TYPE
        CHECK (CHANGE_TYPE IN ('INITIAL_REGISTER', 'ADMIN_RESET', 'USER_CHANGE'))
);

-- 直近 N 件取得用（3世代チェック・最終変更日時取得）
CREATE INDEX IX_AUTH_PASSWORD_HISTORY_USER_CHANGED_AT
    ON AUTH_PASSWORD_HISTORY (AUTH_ACCOUNT_ID, CHANGED_AT DESC);
```

### 4.3 補足

* **LOGIN_PASSWORD**

    * その時点でのハッシュ済みパスワードを保持。
    * 3世代再利用禁止チェック時に、同一ハッシュかどうかで比較。
* **CHANGE_TYPE**

    * `INITIAL_REGISTER`：初回登録
    * `ADMIN_RESET`：管理者による初期化
    * `USER_CHANGE`：ユーザ自身による変更
* **CHANGED_AT**

    * パスワード有効期限（90日）の起点に利用。
* インデックス `AUTH_ACCOUNT_ID + CHANGED_AT DESC`

    * 「直近3件」「最終変更日時」の取得を高速化。

---

## 5. AUTH_LOGIN_HISTORY（ログイン履歴）

### 5.1 役割

* ログイン成功／失敗／ロック中試行／無効アカウント試行などの履歴を記録。
* 前回ログイン日時・連続失敗回数の集計に使用。
* ドメインの `LoginHistory` + `LoginResult` に対応。

### 5.2 DDL

```sql
CREATE TABLE AUTH_LOGIN_HISTORY (
    AUTH_LOGIN_HISTORY_ID   BIGINT GENERATED BY DEFAULT AS IDENTITY,
    AUTH_ACCOUNT_ID         BIGINT          NOT NULL,
    LOGIN_AT                TIMESTAMP       NOT NULL,
    RESULT                  VARCHAR(20)     NOT NULL,      -- SUCCESS / FAIL / LOCKED / DISABLED

    CREATED_AT              TIMESTAMP       NOT NULL,
    CREATED_BY              VARCHAR(100)    NOT NULL,

    CONSTRAINT PK_AUTH_LOGIN_HISTORY PRIMARY KEY (AUTH_LOGIN_HISTORY_ID),
    CONSTRAINT FK_AUTH_LOGIN_HISTORY_USER FOREIGN KEY (AUTH_ACCOUNT_ID)
        REFERENCES AUTH_ACCOUNT (AUTH_ACCOUNT_ID),
    CONSTRAINT CK_AUTH_LOGIN_RESULT
        CHECK (RESULT IN ('SUCCESS', 'FAIL', 'LOCKED', 'DISABLED'))
);

-- ユーザごとの直近履歴取得用
CREATE INDEX IX_AUTH_LOGIN_HISTORY_USER_LOGIN_AT
    ON AUTH_LOGIN_HISTORY (AUTH_ACCOUNT_ID, LOGIN_AT DESC);
```

### 5.3 補足

* **RESULT**

    * `SUCCESS`：認証成功
    * `FAIL`：認証失敗（パスワード不一致など）
    * `LOCKED`：ロック中のログイン試行（失敗カウントには含めない仕様）
    * `DISABLED`：無効アカウントでのログイン試行
* **LOGIN_AT**

    * 「前回ログイン日時」計算に使用（`LoginHistoryDomainService` で SUCCESS の2件目を取得）。

---

## 6. AUTH_ACCOUNT_LOCK_HISTORY（ロック履歴）

### 6.1 役割

* アカウントのロック／ロック解除イベントを履歴として保持。
* 最新イベントから「現在ロック中かどうか」を判定。
* ドメインの `AccountLockEvent` に対応。

### 6.2 DDL

```sql
CREATE TABLE AUTH_ACCOUNT_LOCK_HISTORY (
    AUTH_ACCOUNT_LOCK_HISTORY_ID  BIGINT GENERATED BY DEFAULT AS IDENTITY,
    AUTH_ACCOUNT_ID               BIGINT        NOT NULL,
    LOCKED                        CHAR(1)       NOT NULL,   -- '1':LOCK, '0':UNLOCK
    OCCURRED_AT                   TIMESTAMP     NOT NULL,
    REASON                        VARCHAR(255)  NOT NULL,   -- LOGIN_FAIL_THRESHOLD / ADMIN_UNLOCK 等
    OPERATED_BY_USER_ID           VARCHAR(100)  NOT NULL,

    CREATED_AT                    TIMESTAMP     NOT NULL,
    CREATED_BY                    VARCHAR(100)  NOT NULL,

    CONSTRAINT PK_AUTH_ACCOUNT_LOCK_HISTORY PRIMARY KEY (AUTH_ACCOUNT_LOCK_HISTORY_ID),
    CONSTRAINT FK_AUTH_ACCOUNT_LOCK_HISTORY_USER FOREIGN KEY (AUTH_ACCOUNT_ID)
        REFERENCES AUTH_ACCOUNT (AUTH_ACCOUNT_ID),
    CONSTRAINT CK_AUTH_ACCOUNT_LOCK_LOCKED
        CHECK (LOCKED IN ('0', '1'))
);

-- 最新 LOCK/UNLOCK 取得用
CREATE INDEX IX_AUTH_ACCOUNT_LOCK_HISTORY_USER_OCCURRED_AT
    ON AUTH_ACCOUNT_LOCK_HISTORY (AUTH_ACCOUNT_ID, OCCURRED_AT DESC);
```

### 6.3 補足

* **LOCKED = '1'**

    * ロックイベント（例：連続6回失敗でロック）
* **LOCKED = '0'**

    * ロック解除イベント（例：管理者の解除、パスワード初期化時の解除）
* **REASON**

    * 例：`LOGIN_FAIL_THRESHOLD`, `ADMIN_UNLOCK`, `ADMIN_RESET_AND_UNLOCK` 等
    * ロック・解除の原因を追跡するための文字列。
* `AccountLockDomainService` で

    * 最新イベント（`OCCURRED_AT` 最大）を取得し、LOCK か UNLOCK かで現在状態を判定。

---

## 7. USER_PROFILE（業務側ユーザプロファイル：参考）

### 7.1 役割

* ユーザの業務情報（氏名、社員番号、部署コード、メール等）を保持。
* 認証系とは別コンテキスト（account）で業務Tが設計・実装。
* 認証ドメインとは `AUTH_ACCOUNT_ID` でゆるく結合。

### 7.2 DDL（例）

```sql
CREATE TABLE USER_PROFILE (
    AUTH_ACCOUNT_ID    BIGINT          NOT NULL,   -- AUTH_ACCOUNT.AUTH_ACCOUNT_ID
    EMPLOYEE_NO        VARCHAR(50),
    USER_NAME          VARCHAR(100),
    DEPARTMENT_CODE    VARCHAR(50),
    EMAIL              VARCHAR(200),

    CREATED_AT         TIMESTAMP       NOT NULL,
    CREATED_BY         VARCHAR(100)    NOT NULL,
    UPDATED_AT         TIMESTAMP       NOT NULL,
    UPDATED_BY         VARCHAR(100)    NOT NULL,
    VERSION_NO         BIGINT          NOT NULL,

    CONSTRAINT PK_USER_PROFILE PRIMARY KEY (AUTH_ACCOUNT_ID),
    CONSTRAINT FK_USER_PROFILE_AUTH_ACCOUNT FOREIGN KEY (AUTH_ACCOUNT_ID)
        REFERENCES AUTH_ACCOUNT (AUTH_ACCOUNT_ID)
);
```

### 7.3 補足

* `AUTH_ACCOUNT` とは 1:1 関係。
* アカウント管理画面では、

    * 認証系情報：`AUTH_ACCOUNT` + `AUTH_ROLE` + `AUTH_ACCOUNT_ROLE` など（AP基盤）
    * 業務系情報：`USER_PROFILE`（業務T）
      を組み合わせて表示する。

---

## 8. H2 利用時の留意点

* 開発環境では、H2 を **PostgreSQL モード** で起動することを推奨：

  ```text
  jdbc:h2:mem:ecsite;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE;DB_CLOSE_DELAY=-1
  ```

* `MODE=PostgreSQL`

    * `GENERATED BY DEFAULT AS IDENTITY` や多くの Postgres 方言が利用可能になる。

* `DATABASE_TO_LOWER=TRUE`

    * クォート無し識別子が小文字化される。
      大文字テーブル名をそのまま使う場合は、SQL 側で `"AUTH_ACCOUNT"` のようにクォートするか、
      開発時は小文字で DDL を流す等、プロジェクトの方針に合わせて調整する。

---


