# H2 用 DDL（開発用）

## 0)（任意）PostgreSQL互換モード

可能なら起動オプションやJDBC URLで入れておくと、方言差が減ります。

* `jdbc:h2:mem:test;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE;DEFAULT_NULL_ORDERING=HIGH`

（ただし、今回のDDLは互換モード無しでも動く書き方です）

---

## 1) AUTH_ACCOUNT

```sql
CREATE TABLE AUTH_ACCOUNT (
  auth_account_id  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id          VARCHAR(64) NOT NULL,
  password_hash    VARCHAR(255) NOT NULL,
  role_code        VARCHAR(64) NOT NULL,
  enabled          BOOLEAN NOT NULL DEFAULT TRUE,
  created_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX ux_auth_account_user_id
  ON AUTH_ACCOUNT(user_id);

CREATE INDEX ix_auth_account_role_code
  ON AUTH_ACCOUNT(role_code);

CREATE INDEX ix_auth_account_enabled
  ON AUTH_ACCOUNT(enabled);
```

---

## 2) AUTH_PASSWORD_HISTORY

```sql
CREATE TABLE AUTH_PASSWORD_HISTORY (
  auth_password_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  auth_account_id          BIGINT NOT NULL,
  change_type              VARCHAR(32) NOT NULL,
  changed_at               TIMESTAMP NOT NULL,
  password_hash            VARCHAR(255) NOT NULL,
  created_at               TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT fk_auth_pw_hist_account
    FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT(auth_account_id)
);

CREATE INDEX ix_auth_pw_hist_account_changed
  ON AUTH_PASSWORD_HISTORY(auth_account_id, changed_at);
```

> H2は `DESC` を付けても動きますが、開発用途なら省略でもOKです（ORDER BYで補えます）。

---

## 3) AUTH_LOGIN_HISTORY

```sql
CREATE TABLE AUTH_LOGIN_HISTORY (
  auth_login_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  auth_account_id       BIGINT NOT NULL,
  result                VARCHAR(32) NOT NULL,
  login_at              TIMESTAMP NOT NULL,
  created_at            TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT fk_auth_login_hist_account
    FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT(auth_account_id)
);

CREATE INDEX ix_auth_login_hist_account_at
  ON AUTH_LOGIN_HISTORY(auth_account_id, login_at);

CREATE INDEX ix_auth_login_hist_account_result_at
  ON AUTH_LOGIN_HISTORY(auth_account_id, result, login_at);
```

---

## 4) AUTH_ACCOUNT_LOCK_HISTORY

```sql
CREATE TABLE AUTH_ACCOUNT_LOCK_HISTORY (
  auth_account_lock_history_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  auth_account_id              BIGINT NOT NULL,
  event_type                   VARCHAR(32) NOT NULL,
  occurred_at                  TIMESTAMP NOT NULL,
  created_at                   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT fk_auth_lock_hist_account
    FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT(auth_account_id)
);

CREATE INDEX ix_auth_lock_hist_account_at
  ON AUTH_ACCOUNT_LOCK_HISTORY(auth_account_id, occurred_at);
```

---

## 補足（H2でよくハマる点）

* `CURRENT_TIMESTAMP` はH2でもOK
* FK制約を有効にしている場合、投入順は **AUTH_ACCOUNT → 履歴** の順にする
* `updated_at` を自動更新したいなら、アプリ側で更新（DBトリガは今回スコープ外でOK）

---

次は、**PostgreSQL版DDLも含めて「FlywayでDB別にどう分けるか（Vxxx__pg.sql / Vxxx__h2.sql）」の構成案**まで設計として固めますか？
