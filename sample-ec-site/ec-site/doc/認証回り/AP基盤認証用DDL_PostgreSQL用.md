# 認証基盤 DDL（確定版案）

## 1) AUTH_ACCOUNT（認証マスタ）

* 役割：ログイン対象アカウントの現在状態（パスワード/有効無効/ロール）を保持
* `user_id` は画面入力「ユーザID」＝ログインに使用（UNIQUE）
* `auth_account_id` は内部不変ID（PK）

```sql
-- =========================
-- AUTH_ACCOUNT
-- =========================
CREATE TABLE AUTH_ACCOUNT (
  auth_account_id  BIGSERIAL PRIMARY KEY,
  user_id          VARCHAR(64) NOT NULL,
  password_hash    VARCHAR(255) NOT NULL,
  role_code        VARCHAR(64) NOT NULL,
  enabled          BOOLEAN NOT NULL DEFAULT TRUE,
  created_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- user_id はログインに使うため必ず一意
CREATE UNIQUE INDEX ux_auth_account_user_id
  ON AUTH_ACCOUNT(user_id);

-- 検索・絞り込み用（必要最低限）
CREATE INDEX ix_auth_account_role_code
  ON AUTH_ACCOUNT(role_code);

CREATE INDEX ix_auth_account_enabled
  ON AUTH_ACCOUNT(enabled);
```

> `updated_at` は password_hash / enabled 更新が発生するため保持（Update最小方針でも更新は不可避）。

---

## 2) AUTH_PASSWORD_HISTORY（パスワード履歴：insert-only）

* 役割：

    * 初回 / 初期化後の **強制パスワード変更**（INITIAL_REGISTER / ADMIN_RESET）
    * パスワード **有効期限（90日）**
    * **3世代禁止**（直近3件と照合）
* `password_hash` は当時のハッシュを保存（raw比較ではなく `PasswordEncoder.matches` で照合）

```sql
-- =========================
-- AUTH_PASSWORD_HISTORY
-- =========================
CREATE TABLE AUTH_PASSWORD_HISTORY (
  auth_password_history_id BIGSERIAL PRIMARY KEY,
  auth_account_id          BIGINT NOT NULL,
  change_type              VARCHAR(32) NOT NULL,  -- INITIAL_REGISTER / ADMIN_RESET / USER_CHANGE
  changed_at               TIMESTAMP NOT NULL,
  password_hash            VARCHAR(255) NOT NULL,
  created_at               TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT fk_auth_pw_hist_account
    FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT(auth_account_id)
);

-- 最新取得・世代取得で必須
CREATE INDEX ix_auth_pw_hist_account_changed
  ON AUTH_PASSWORD_HISTORY(auth_account_id, changed_at DESC);
```

---

## 3) AUTH_LOGIN_HISTORY（ログイン履歴：insert-only）

* 役割：

    * 連続失敗の算出（FAILUREを対象、SUCCESSで区切る）
    * LOCKED/DISABLED も監査として残す（失敗カウントに含めない）
    * 前回ログイン日時表示（SUCCESSの直近）
* 要件「user not found は履歴に残さない」前提なら、基本は必ず `auth_account_id` が入る

```sql
-- =========================
-- AUTH_LOGIN_HISTORY
-- =========================
CREATE TABLE AUTH_LOGIN_HISTORY (
  auth_login_history_id BIGSERIAL PRIMARY KEY,
  auth_account_id       BIGINT NOT NULL,
  result                VARCHAR(32) NOT NULL,  -- SUCCESS / FAILURE / LOCKED / DISABLED
  login_at              TIMESTAMP NOT NULL,
  created_at            TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT fk_auth_login_hist_account
    FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT(auth_account_id)
);

-- 前回ログイン日時（SUCCESS最新）・直近履歴参照で必須
CREATE INDEX ix_auth_login_hist_account_at
  ON AUTH_LOGIN_HISTORY(auth_account_id, login_at DESC);

-- result別の最新取得・集計で便利（Lock判定/前回SUCCESS等）
CREATE INDEX ix_auth_login_hist_account_result_at
  ON AUTH_LOGIN_HISTORY(auth_account_id, result, login_at DESC);
```

---

## 4) AUTH_ACCOUNT_LOCK_HISTORY（ロック履歴：insert-only）

* 役割：LOCK/UNLOCKイベントを積み、現在ロック状態を `AccountLockEvents` で算出
* 方針A：LOCKイベント重複は許容（最新イベントで状態算出）

```sql
-- =========================
-- AUTH_ACCOUNT_LOCK_HISTORY
-- =========================
CREATE TABLE AUTH_ACCOUNT_LOCK_HISTORY (
  auth_account_lock_history_id BIGSERIAL PRIMARY KEY,
  auth_account_id              BIGINT NOT NULL,
  event_type                   VARCHAR(32) NOT NULL, -- LOCK / UNLOCK
  occurred_at                  TIMESTAMP NOT NULL,
  created_at                   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT fk_auth_lock_hist_account
    FOREIGN KEY (auth_account_id) REFERENCES AUTH_ACCOUNT(auth_account_id)
);

-- 最新イベント取得で必須
CREATE INDEX ix_auth_lock_hist_account_at
  ON AUTH_ACCOUNT_LOCK_HISTORY(auth_account_id, occurred_at DESC);
```

---

# 5) 参照用SQL（設計上の“確定クエリ”）

AP基盤で必ず使うクエリを、設計として固定しておくとブレません。

### 5.1 ユーザID（画面）→ アカウント取得

```sql
SELECT *
FROM AUTH_ACCOUNT
WHERE user_id = ?;
```

### 5.2 前回ログイン日時（SUCCESS最新）

```sql
SELECT login_at
FROM AUTH_LOGIN_HISTORY
WHERE auth_account_id = ?
  AND result = 'SUCCESS'
ORDER BY login_at DESC
LIMIT 1;
```

### 5.3 パスワード履歴最新

```sql
SELECT *
FROM AUTH_PASSWORD_HISTORY
WHERE auth_account_id = ?
ORDER BY changed_at DESC
LIMIT 1;
```

### 5.4 パスワード履歴直近3件

```sql
SELECT *
FROM AUTH_PASSWORD_HISTORY
WHERE auth_account_id = ?
ORDER BY changed_at DESC
LIMIT 3;
```

### 5.5 ロックイベント最新

```sql
SELECT *
FROM AUTH_ACCOUNT_LOCK_HISTORY
WHERE auth_account_id = ?
ORDER BY occurred_at DESC
LIMIT 1;
```

---

# 6) H2（開発）での注意点（設計メモ）

* `BIGSERIAL`：H2では `BIGINT GENERATED BY DEFAULT AS IDENTITY` に読み替えが必要な場合あり
  → Flyway/LiquibaseでDB別DDLを分けるか、方言吸収設定を入れる
* `TIMESTAMP` / `BOOLEAN` はH2でも基本OK
* `DESC` index はH2が無視する場合があるが、開発用途なら許容

---
