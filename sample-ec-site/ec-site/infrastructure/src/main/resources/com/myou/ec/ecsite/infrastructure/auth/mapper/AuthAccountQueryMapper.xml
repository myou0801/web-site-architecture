<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myou.ec.ecsite.infrastructure.auth.mapper.AuthAccountQueryMapper">

    <sql id="selectAuthAccountColumns">
        AUTH_ACCOUNT_ID,
        USER_ID,
        ACCOUNT_STATUS,
        LOCKED,
        EXPIRED,
        CREATED_AT,
        UPDATED_AT,
        LAST_LOGIN_AT
    </sql>

    <sql id="whereAuthAccountCriteria">
        <where>
            <if test="userIdPrefix != null and userIdPrefix != ''">
                AND USER_ID LIKE #{userIdPrefix} || '%'
            </if>
            <if test="accountStatuses != null and !accountStatuses.isEmpty()">
                AND ACCOUNT_STATUS IN
                <foreach item="status" collection="accountStatuses" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="locked != null">
                AND LOCKED = #{locked}
            </if>
            <if test="expired != null">
                AND EXPIRED = #{expired}
            </if>
        </where>
    </sql>

    <select id="selectSummaries"
            resultType="com.myou.ec.ecsite.infrastructure.auth.record.AuthAccountSummaryRecord">
        SELECT
        <include refid="selectAuthAccountColumns"/>
        FROM
        AUTH_ACCOUNT_CURRENT_V
        <include refid="whereAuthAccountCriteria"/>
        ORDER BY
        <choose>
            <when test="sortKey == 'USER_ID'">USER_ID</when>
            <when test="sortKey == 'CREATED_AT'">CREATED_AT</when>
            <when test="sortKey == 'UPDATED_AT'">UPDATED_AT</when>
            <when test="sortKey == 'LAST_LOGIN_AT'">LAST_LOGIN_AT</when>
            <otherwise>USER_ID</otherwise>
        </choose>
        <if test="sortDirection == 'DESC'">DESC</if>
        <if test="sortDirection == 'ASC'">ASC</if>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countSummaries" resultType="long">
        SELECT
        COUNT(AUTH_ACCOUNT_ID)
        FROM
        AUTH_ACCOUNT_CURRENT_V
        <include refid="whereAuthAccountCriteria"/>
    </select>

    <select id="selectDetailByUserId"
            resultType="com.myou.ec.ecsite.infrastructure.auth.record.AuthAccountDetailRecord">
        SELECT
        <include refid="selectAuthAccountColumns"/>
        FROM
        AUTH_ACCOUNT_CURRENT_V
        WHERE
        USER_ID = #{userId}
    </select>

</mapper>
